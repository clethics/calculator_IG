<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¼ê´‘ì¤‘í•™êµ ê²°ì‹œì ì¸ì •ì  ê³„ì‚°ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .selected { 
            @apply ring-4 ring-red-500 ring-opacity-80 transform scale-110 shadow-2xl; 
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%) !important;
            color: white !important;
            font-weight: 900 !important;
            border: 3px solid #ef4444 !important;
            animation: selectedPulse 1.5s infinite;
            position: relative;
            z-index: 10;
        }
        .selected:hover {
            @apply transform scale-110;
            background: linear-gradient(135deg, #b91c1c 0%, #7f1d1d 100%) !important;
        }
        .selected::before {
            content: 'âœ“';
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        @keyframes selectedPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.6); }
            50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
        }
        .btn-hover:hover { 
            @apply transform scale-105 transition-all duration-200; 
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 text-center mb-2">ğŸ« ì¼ê´‘ì¤‘í•™êµ ê²°ì‹œì ì¸ì •ì  ê³„ì‚°ê¸° ğŸ«</h1>
            <p class="text-gray-600 text-center mb-8">ğŸ˜Šì¸ì •ì  ê³„ì‚°ì„ ë³´ë‹¤ í¸ë¦¬í•˜ê²ŒğŸ˜Š</p>
            
            <!-- í•™ë…„/ê³¼ëª© ì„ íƒ -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">ğŸ‘¤ í•™ë…„/ê³¼ëª© ì„ íƒ</h2>
                <div class="bg-gray-50 rounded-xl p-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">í•™ë…„</label>
                            <select id="student-grade" onchange="handleGradeSubjectChange()" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">ì„ íƒ</option>
                                <option value="1">1í•™ë…„</option>
                                <option value="2">2í•™ë…„</option>
                                <option value="3">3í•™ë…„</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ê³¼ëª©</label>
                            <select id="student-subject" onchange="handleGradeSubjectChange()" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">ì„ íƒ</option>
                                <option value="êµ­ì–´">êµ­ì–´</option>
                                <option value="ì˜ì–´">ì˜ì–´</option>
                                <option value="ìˆ˜í•™">ìˆ˜í•™</option>
                                <option value="ì‚¬íšŒ">ì‚¬íšŒ</option>
                                <option value="ê³¼í•™">ê³¼í•™</option>
                                <option value="ë„ë•">ë„ë•</option>
                                <option value="í•œë¬¸">í•œë¬¸</option>
                                <option value="ì—­ì‚¬">ì—­ì‚¬</option>
                                <option value="ê¸°ìˆ ê°€ì •">ê¸°ìˆ ê°€ì •</option>
                                <option value="ì •ë³´">ì •ë³´</option>
                                <option value="ìŒì•…">ìŒì•…</option>
                                <option value="ë¯¸ìˆ ">ë¯¸ìˆ </option>
                                <option value="ì²´ìœ¡">ì²´ìœ¡</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- í‰ê·  ì ìˆ˜ ê´€ë¦¬ -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">ğŸ“Š í‰ê·  ì ìˆ˜ ê´€ë¦¬</h2>
                <div class="bg-white border-2 border-gray-200 rounded-xl p-6">
                    <div class="space-y-6">
                        <!-- ì§€í•„ê³ ì‚¬ í‰ê·  -->
                        <div id="written-exam-section" class="bg-blue-50 rounded-xl p-6">
                            <h4 class="text-lg font-semibold text-blue-800 mb-4">ğŸ“ ì§€í•„ê³ ì‚¬ í‰ê· </h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ì¤‘ê°„ê³ ì‚¬ í‰ê· </label>
                                    <input type="number" step="0.1" id="midterm-avg-input" placeholder="ì˜ˆ: 75.5" 
                                           oninput="autoSaveAverages()" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <input type="number" step="0.1" id="midterm-min-input" placeholder="ìµœí•˜ì  (ì˜ˆ: 40)" 
                                           oninput="autoSaveAverages()" class="w-full mt-2 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ê¸°ë§ê³ ì‚¬ í‰ê· </label>
                                    <input type="number" step="0.1" id="final-avg-input" placeholder="ì˜ˆ: 78.2" 
                                           oninput="autoSaveAverages()" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <input type="number" step="0.1" id="final-min-input" placeholder="ìµœí•˜ì  (ì˜ˆ: 40)" 
                                           oninput="autoSaveAverages()" class="w-full mt-2 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>

                        <!-- ìˆ˜í–‰í‰ê°€ í‰ê·  -->
                        <div class="bg-purple-50 rounded-xl p-6">
                            <h4 class="text-lg font-semibold text-purple-800 mb-4">ğŸ“‹ ìˆ˜í–‰í‰ê°€ í‰ê·  (ìµœëŒ€ 4ê°œ ì˜ì—­)</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">1ì˜ì—­</label>
                                        <input type="text" id="perf1-name-input" placeholder="ì˜ì—­ëª… (ì˜ˆ: ë§í•˜ê¸°)" 
                                               oninput="autoSaveAverages()" class="w-full mb-2 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                        <input type="number" step="0.1" id="perf1-avg-input" placeholder="í‰ê·  (ì˜ˆ: 85.3)" 
                                               oninput="autoSaveAverages()" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                        <input type="number" step="0.1" id="perf1-min-input" placeholder="ìµœí•˜ì  (ì˜ˆ: 40)" 
                                               oninput="autoSaveAverages()" class="w-full mt-2 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">2ì˜ì—­</label>
                                        <input type="text" id="perf2-name-input" placeholder="ì˜ì—­ëª… (ì˜ˆ: ë“£ê¸°)" 
                                               oninput="autoSaveAverages()" class="w-full mb-2 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                        <input type="number" step="0.1" id="perf2-avg-input" placeholder="í‰ê·  (ì˜ˆ: 82.7)" 
                                               oninput="autoSaveAverages()" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                        <input type="number" step="0.1" id="perf2-min-input" placeholder="ìµœí•˜ì  (ì˜ˆ: 40)" 
                                               oninput="autoSaveAverages()" class="w-full mt-2 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                    </div>
                                </div>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">3ì˜ì—­</label>
                                        <input type="text" id="perf3-name-input" placeholder="ì˜ì—­ëª… (ì˜ˆ: ì½ê¸°)" 
                                               oninput="autoSaveAverages()" class="w-full mb-2 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                        <input type="number" step="0.1" id="perf3-avg-input" placeholder="í‰ê·  (ì˜ˆ: 79.8)" 
                                               oninput="autoSaveAverages()" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                        <input type="number" step="0.1" id="perf3-min-input" placeholder="ìµœí•˜ì  (ì˜ˆ: 40)" 
                                               oninput="autoSaveAverages()" class="w-full mt-2 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">4ì˜ì—­</label>
                                        <input type="text" id="perf4-name-input" placeholder="ì˜ì—­ëª… (ì˜ˆ: ì“°ê¸°)" 
                                               oninput="autoSaveAverages()" class="w-full mb-2 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                        <input type="number" step="0.1" id="perf4-avg-input" placeholder="í‰ê·  (ì˜ˆ: 81.2)" 
                                               oninput="autoSaveAverages()" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                        <input type="number" step="0.1" id="perf4-min-input" placeholder="ìµœí•˜ì  (ì˜ˆ: 40)" 
                                               oninput="autoSaveAverages()" class="w-full mt-2 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ì˜ì–´ë“£ê¸° í‰ê·  (ì˜ì–´ ê³¼ëª©ë§Œ) -->
                        <div id="english-listening-section" class="bg-orange-50 rounded-xl p-6 hidden">
                            <h4 class="text-lg font-semibold text-orange-800 mb-4">ğŸ§ ì˜ì–´ë“£ê¸° í‰ê°€ í‰ê· </h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ì˜ì–´ë“£ê¸° í‰ê· </label>
                                    <input type="number" step="0.1" id="listening-avg-input" placeholder="ì˜ˆ: 82.5" 
                                           oninput="autoSaveAverages()" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                    <input type="number" step="0.1" id="listening-min-input" placeholder="ìµœí•˜ì  (ì˜ˆ: 40)" 
                                           oninput="autoSaveAverages()" class="w-full mt-2 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- í•™ìƒ ì •ë³´ ì…ë ¥ -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">ğŸ‘¤ í•™ìƒ ì •ë³´</h2>
                <div class="bg-gray-50 rounded-xl p-6">
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ë°˜</label>
                            <input type="number" id="student-class" placeholder="ì˜ˆ: 3" min="1" max="20"
                                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ë²ˆí˜¸</label>
                            <input type="number" id="student-number" placeholder="ì˜ˆ: 15" min="1" max="50"
                                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ì´ë¦„</label>
                            <input type="text" id="student-name" placeholder="ì˜ˆ: í™ê¸¸ë™"
                                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ì‹œí—˜ ìœ í˜• ì„ íƒ -->
            <div id="exam-type-section" class="mb-8">
                <label class="block text-lg font-semibold text-gray-700 mb-4">ê²°ì‹œí•œ ì‹œí—˜ ìœ í˜•</label>
                <div id="exam-type-buttons" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <button type="button" onclick="selectExamType('midterm')" id="midterm-btn" 
                            class="btn-hover bg-blue-100 hover:bg-blue-200 text-blue-800 font-bold py-6 px-8 rounded-xl border-3 border-blue-300 transition-all duration-200 text-lg shadow-md">
                        ğŸ“ ì¤‘ê°„ê³ ì‚¬
                    </button>
                    <button type="button" onclick="selectExamType('final')" id="final-btn" 
                            class="btn-hover bg-green-100 hover:bg-green-200 text-green-800 font-bold py-6 px-8 rounded-xl border-3 border-green-300 transition-all duration-200 text-lg shadow-md">
                        ğŸ“ ê¸°ë§ê³ ì‚¬
                    </button>
                    <button type="button" onclick="selectExamType('performance')" id="performance-btn" 
                            class="btn-hover bg-purple-100 hover:bg-purple-200 text-purple-800 font-bold py-6 px-8 rounded-xl border-3 border-purple-300 transition-all duration-200 text-lg shadow-md">
                        ğŸ“‹ ìˆ˜í–‰í‰ê°€
                    </button>
                    <button type="button" onclick="selectExamType('english-listening')" id="english-listening-btn" 
                            class="btn-hover bg-orange-100 hover:bg-orange-200 text-orange-800 font-bold py-6 px-8 rounded-xl border-3 border-orange-300 transition-all duration-200 text-lg shadow-md hidden">
                        ğŸ§ ì˜ì–´ë“£ê¸°
                    </button>
                </div>
                <div id="performance-only-notice" class="hidden mt-4 bg-purple-50 border border-purple-200 rounded-lg p-4">
                    <p class="text-purple-800 text-sm">
                        <strong>ğŸ’¡ ì•ˆë‚´:</strong> ì„ íƒí•˜ì‹  ê³¼ëª©ì€ ìˆ˜í–‰í‰ê°€ë§Œ ì‹¤ì‹œë˜ëŠ” ê³¼ëª©ì…ë‹ˆë‹¤.
                    </p>
                </div>
                <div id="english-listening-notice" class="hidden mt-4 bg-orange-50 border border-orange-200 rounded-lg p-4">
                    <p class="text-orange-800 text-sm">
                        <strong>ğŸ§ ì•ˆë‚´:</strong> ì˜ì–´ ê³¼ëª©ì—ì„œëŠ” ì˜ì–´ë“£ê¸° í‰ê°€ ì¸ì •ì ë„ ê³„ì‚°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </p>
                </div>
            </div>

            <!-- ê²°ì‹œ ì‚¬ìœ  ì„ íƒ -->
            <div id="absence-reason" class="mb-8 hidden">
                <label class="block text-lg font-semibold text-gray-700 mb-4">ê²°ì‹œ ì‚¬ìœ </label>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <button type="button" onclick="selectAbsenceReason('sick')" id="sick-btn" 
                            class="btn-hover bg-red-100 hover:bg-red-200 text-red-800 font-bold py-6 px-8 rounded-xl border-3 border-red-300 transition-all duration-200 shadow-md">
                        <div class="text-center">
                            <div class="text-xl font-bold">ğŸ¤’ ë³‘ê²°</div>
                            <div class="text-base mt-2">80% ì¸ì •</div>
                        </div>
                    </button>
                    <button type="button" onclick="selectAbsenceReason('approved')" id="approved-btn" 
                            class="btn-hover bg-blue-100 hover:bg-blue-200 text-blue-800 font-bold py-6 px-8 rounded-xl border-3 border-blue-300 transition-all duration-200 shadow-md">
                        <div class="text-center">
                            <div class="text-xl font-bold">âœ… ì¸ì •ê²°</div>
                            <div class="text-base mt-2">100% ì¸ì •</div>
                        </div>
                    </button>
                    <button type="button" onclick="selectAbsenceReason('unapproved')" id="unapproved-btn" 
                            class="btn-hover bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-6 px-8 rounded-xl border-3 border-gray-300 transition-all duration-200 shadow-md">
                        <div class="text-center">
                            <div class="text-xl font-bold">âŒ ë¯¸ì¸ì •ê²°</div>
                            <div class="text-base mt-2">ìµœí•˜ì -1ì </div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- ê³„ì‚° ë°©ì‹ ì„ íƒ -->
            <div id="calculation-method" class="mb-8 hidden">
                <label class="block text-lg font-semibold text-gray-700 mb-4">ê³„ì‚° ë°©ì‹ ì„ íƒ</label>
                <div id="method-options" class="space-y-3">
                    <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                </div>
            </div>

            <!-- ì…ë ¥ í¼ -->
            <div id="input-form" class="mb-8 hidden">
                <div class="bg-gray-50 rounded-xl p-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">í•„ìš”í•œ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</h3>
                    <div id="input-fields" class="space-y-4">
                        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                    </div>
                    <button type="button" onclick="calculateScore()" 
                            class="w-full mt-6 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105">
                        ì¸ì •ì  ê³„ì‚°í•˜ê¸°
                    </button>
                </div>
            </div>

            <!-- ê²°ê³¼ í‘œì‹œ -->
            <div id="result" class="hidden">
                <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-green-800">ğŸ“Š ê³„ì‚° ê²°ê³¼</h3>
                        <div class="space-x-2">
                            <button type="button" onclick="exportToExcelApproval()" 
                                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">
                                ğŸ“Š ê²°ì¬ìš© ì—‘ì…€ ì €ì¥
                            </button>
                            <button type="button" onclick="exportToExcelReview()" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">
                                ğŸ“‹ í‰ê°€ê³„ ê²€í† ìš© ì—‘ì…€ ì €ì¥
                            </button>
                            <button type="button" onclick="copyResults()" 
                                    class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">
                                ë³µì‚¬í•˜ê¸°
                            </button>
                            <button type="button" onclick="clearResults()" 
                                    class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">
                                ì „ì²´ ì‚­ì œ
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table id="results-table" class="w-full border-collapse border border-gray-300 bg-white rounded-lg overflow-hidden shadow-sm">
                            <thead>
                                <tr class="bg-green-100">
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">ë²ˆí˜¸</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">í•™ë…„</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">ë°˜</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">ë²ˆí˜¸</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">ì´ë¦„</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">ê³¼ëª©</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">ê²°ì‹œì‹œí—˜</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">ì„¸ë¶€ëª…</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">ê²°ì‹œì‚¬ìœ </th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">ì¸ì •ë¹„ìœ¨</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">ê³„ì‚° ê¸°ì¤€</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">ìµœí•˜ì </th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">ê¸°ì¤€ì </th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">ì¸ì •ì </th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">ë¹„ê³ </th>
                                    <th class="border border-gray-300 px-3 py-2 text-center font-semibold text-green-800 text-sm">ì‚­ì œ</th>
                                </tr>
                            </thead>
                            <tbody id="results-tbody">
                                <!-- ê²°ê³¼ê°€ ì—¬ê¸°ì— ëˆ„ì ë©ë‹ˆë‹¤ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ê³„ì‚° ê³µì‹ ì•ˆë‚´ ë²„íŠ¼ -->
        <div class="text-center">
            <button type="button" onclick="openFormulaModal()" 
                    class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-3 rounded-xl font-medium transition-all duration-200 border border-gray-300">
                ğŸ“‹ ê³„ì‚° ê³µì‹ ì•ˆë‚´ ë³´ê¸°
            </button>
        </div>
    </div>

    <!-- ê³„ì‚° ê³µì‹ ì•ˆë‚´ ëª¨ë‹¬ -->
    <div id="formula-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">ğŸ“‹ ê³„ì‚° ê³µì‹ ì•ˆë‚´</h3>
                <button type="button" onclick="closeFormulaModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-4 mb-6">
                <h3 class="font-semibold text-yellow-800 mb-3">ğŸ¯ ê²°ì‹œ ì‚¬ìœ ë³„ ì¸ì • ë¹„ìœ¨</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div class="text-center p-3 bg-red-100 rounded-lg">
                        <div class="font-semibold text-red-800">ë³‘ê²°</div>
                        <div class="text-red-600">ê³„ì‚°ëœ ì ìˆ˜ì˜ 80%</div>
                    </div>
                    <div class="text-center p-3 bg-blue-100 rounded-lg">
                        <div class="font-semibold text-blue-800">ì¸ì •ê²°</div>
                        <div class="text-blue-600">ê³„ì‚°ëœ ì ìˆ˜ì˜ 100%</div>
                    </div>
                    <div class="text-center p-3 bg-gray-100 rounded-lg">
                        <div class="font-semibold text-gray-800">ë¯¸ì¸ì •ê²°</div>
                        <div class="text-gray-600">ìµœí•˜ì  - 1ì </div>
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="border-l-4 border-blue-500 pl-4">
                    <h3 class="font-semibold text-blue-800 mb-2">ì¤‘ê°„ê³ ì‚¬ ì¸ì •ì </h3>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>â€¢ ê¸°ë§ê³ ì‚¬ ì„±ì  ìˆìŒ: (ê¸°ë§ì ìˆ˜ Ã· ê¸°ë§í‰ê· ) Ã— ì¤‘ê°„í‰ê·  Ã— ì¸ì •ë¹„ìœ¨</li>
                        <li>â€¢ ìˆ˜í–‰í‰ê°€ë§Œ ìˆìŒ: (ìˆ˜í–‰ì ìˆ˜ Ã· ìˆ˜í–‰í‰ê· ) Ã— ì¤‘ê°„í‰ê·  Ã— ì¸ì •ë¹„ìœ¨</li>
                        <li>â€¢ ì„±ì  ì—†ìŒ: ì¤‘ê°„ê³ ì‚¬ ìµœí•˜ì  - 1ì </li>
                    </ul>
                </div>
                <div class="border-l-4 border-green-500 pl-4">
                    <h3 class="font-semibold text-green-800 mb-2">ê¸°ë§ê³ ì‚¬ ì¸ì •ì </h3>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>â€¢ ì¤‘ê°„ê³ ì‚¬ ì„±ì  ìˆìŒ: (ì¤‘ê°„ì ìˆ˜ Ã· ì¤‘ê°„í‰ê· ) Ã— ê¸°ë§í‰ê·  Ã— ì¸ì •ë¹„ìœ¨</li>
                        <li>â€¢ ìˆ˜í–‰í‰ê°€ë§Œ ìˆìŒ: (ìˆ˜í–‰ì ìˆ˜ Ã· ìˆ˜í–‰í‰ê· ) Ã— ê¸°ë§í‰ê·  Ã— ì¸ì •ë¹„ìœ¨</li>
                        <li>â€¢ ì„±ì  ì—†ìŒ: ê¸°ë§ê³ ì‚¬ ìµœí•˜ì  - 1ì </li>
                    </ul>
                </div>
                <div class="border-l-4 border-purple-500 pl-4">
                    <h3 class="font-semibold text-purple-800 mb-2">ìˆ˜í–‰í‰ê°€ ì¸ì •ì </h3>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>â€¢ ë‹¤ë¥¸ ìˆ˜í–‰í‰ê°€ ìˆìŒ: í•™ìƒì˜ ë‹¤ë¥¸ì˜ì—­ í‰ê· ì ìˆ˜ Ã— (ê²°ì‹œì˜ì—­ í•™ë…„í‰ê·  Ã· ë‹¤ë¥¸ì˜ì—­ ì „ì²´í‰ê· ) Ã— ì¸ì •ë¹„ìœ¨</li>
                        <li>â€¢ ì§€í•„í‰ê°€ë§Œ ìˆìŒ: í•™ìƒì˜ ìˆ˜í–‰í‰ê°€ í‰ê· ì ìˆ˜ Ã— (ì§€í•„í‰ê°€ ì „ì²´í‰ê·  Ã· ìˆ˜í–‰í‰ê°€ ì „ì²´í‰ê· ) Ã— ì¸ì •ë¹„ìœ¨</li>
                        <li>â€¢ ì„±ì  ì—†ìŒ: ìˆ˜í–‰í‰ê°€ ìµœí•˜ì  - 1ì </li>
                    </ul>
                </div>
                <div class="border-l-4 border-orange-500 pl-4">
                    <h3 class="font-semibold text-orange-800 mb-2">ì˜ì–´ë“£ê¸° í‰ê°€ ì¸ì •ì </h3>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>â€¢ ì§€í•„ê³ ì‚¬ ì„±ì  ìˆìŒ: (í•™ìƒ ì˜ì–´ì§€í•„ì ìˆ˜ Ã· ì˜ì–´ì§€í•„í‰ê· ) Ã— ì˜ì–´ë“£ê¸°í‰ê·  Ã— ì¸ì •ë¹„ìœ¨</li>
                        <li>â€¢ ìˆ˜í–‰í‰ê°€ë§Œ ìˆìŒ: í•™ìƒ ìˆ˜í–‰í‰ê· ì ìˆ˜ Ã— (ì˜ì–´ë“£ê¸°í‰ê·  Ã· ì˜ì–´ë“£ê¸°ì œì™¸ ìˆ˜í–‰í‰ê· ) Ã— ì¸ì •ë¹„ìœ¨</li>
                        <li>â€¢ ì„±ì  ì—†ìŒ: ì˜ì–´ë“£ê¸° ìµœí•˜ì  - 1ì </li>
                    </ul>
                </div>
            </div>
            
            <div class="flex justify-end mt-6">
                <button type="button" onclick="closeFormulaModal()" 
                        class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all duration-200">
                    í™•ì¸
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentExamType = '';
        let currentMethod = '';
        let currentAbsenceReason = '';
        let isPerformanceOnlySubject = false;
        let resultCounter = 0;
        let resultsData = [];
        let savedAverages = {};

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        window.onload = function() {
            const saved = localStorage.getItem('savedAverages');
            if (saved) {
                savedAverages = JSON.parse(saved);
            }
        };

        function handleGradeSubjectChange() {
            const grade = document.getElementById('student-grade').value;
            const subject = document.getElementById('student-subject').value;
            const performanceOnlySubjects = ['ìŒì•…', 'ë¯¸ìˆ ', 'ì²´ìœ¡'];
            
            isPerformanceOnlySubject = performanceOnlySubjects.includes(subject);
            
            const midtermBtn = document.getElementById('midterm-btn');
            const finalBtn = document.getElementById('final-btn');
            const englishListeningBtn = document.getElementById('english-listening-btn');
            const englishListeningSection = document.getElementById('english-listening-section');
            const performanceNotice = document.getElementById('performance-only-notice');
            const englishNotice = document.getElementById('english-listening-notice');
            const examTypeButtons = document.getElementById('exam-type-buttons');
            
            // ì˜ì–´ë“£ê¸° ê´€ë ¨ í‘œì‹œ/ìˆ¨ê¹€
            if (subject === 'ì˜ì–´') {
                englishListeningBtn.classList.remove('hidden');
                englishListeningSection.classList.remove('hidden');
                englishNotice.classList.remove('hidden');
                examTypeButtons.className = 'grid grid-cols-1 md:grid-cols-4 gap-6';
            } else {
                englishListeningBtn.classList.add('hidden');
                englishListeningSection.classList.add('hidden');
                englishNotice.classList.add('hidden');
                examTypeButtons.className = 'grid grid-cols-1 md:grid-cols-3 gap-6';
            }
            
            if (isPerformanceOnlySubject) {
                midtermBtn.disabled = true;
                finalBtn.disabled = true;
                midtermBtn.classList.add('opacity-50', 'cursor-not-allowed');
                finalBtn.classList.add('opacity-50', 'cursor-not-allowed');
                performanceNotice.classList.remove('hidden');
                selectExamType('performance');
            } else {
                midtermBtn.disabled = false;
                finalBtn.disabled = false;
                midtermBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                finalBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                performanceNotice.classList.add('hidden');
                resetExamTypeSelection();
            }
            
            // ì €ì¥ëœ í‰ê·  ë°ì´í„° ë¡œë“œ
            loadSavedAverages();
        }

        function resetExamTypeSelection() {
            currentExamType = '';
            currentMethod = '';
            currentAbsenceReason = '';
            
            // ëª¨ë“  ë²„íŠ¼ ì´ˆê¸°í™”
            document.getElementById('midterm-btn').classList.remove('selected');
            document.getElementById('final-btn').classList.remove('selected');
            document.getElementById('performance-btn').classList.remove('selected');
            document.getElementById('english-listening-btn').classList.remove('selected');
            document.getElementById('sick-btn').classList.remove('selected');
            document.getElementById('approved-btn').classList.remove('selected');
            document.getElementById('unapproved-btn').classList.remove('selected');
            
            document.getElementById('absence-reason').classList.add('hidden');
            document.getElementById('calculation-method').classList.add('hidden');
            document.getElementById('input-form').classList.add('hidden');
        }

        function selectExamType(type) {
            if (isPerformanceOnlySubject && (type === 'midterm' || type === 'final')) {
                return;
            }
            
            currentExamType = type;
            
            // ëª¨ë“  ì‹œí—˜ ìœ í˜• ë²„íŠ¼ ì„ íƒ í•´ì œ
            document.getElementById('midterm-btn').classList.remove('selected');
            document.getElementById('final-btn').classList.remove('selected');
            document.getElementById('performance-btn').classList.remove('selected');
            document.getElementById('english-listening-btn').classList.remove('selected');
            
            // ì„ íƒëœ ë²„íŠ¼ì— selected í´ë˜ìŠ¤ ì¶”ê°€
            if (type === 'midterm') {
                document.getElementById('midterm-btn').classList.add('selected');
            } else if (type === 'final') {
                document.getElementById('final-btn').classList.add('selected');
            } else if (type === 'performance') {
                document.getElementById('performance-btn').classList.add('selected');
            } else if (type === 'english-listening') {
                document.getElementById('english-listening-btn').classList.add('selected');
            }

            document.getElementById('absence-reason').classList.remove('hidden');
            document.getElementById('calculation-method').classList.add('hidden');
            document.getElementById('input-form').classList.add('hidden');
        }

        function selectAbsenceReason(reason) {
            currentAbsenceReason = reason;
            
            // ëª¨ë“  ê²°ì‹œ ì‚¬ìœ  ë²„íŠ¼ ì„ íƒ í•´ì œ
            document.getElementById('sick-btn').classList.remove('selected');
            document.getElementById('approved-btn').classList.remove('selected');
            document.getElementById('unapproved-btn').classList.remove('selected');
            
            // ì„ íƒëœ ë²„íŠ¼ì— selected í´ë˜ìŠ¤ ì¶”ê°€
            if (reason === 'sick') {
                document.getElementById('sick-btn').classList.add('selected');
            } else if (reason === 'approved') {
                document.getElementById('approved-btn').classList.add('selected');
            } else if (reason === 'unapproved') {
                document.getElementById('unapproved-btn').classList.add('selected');
            }

            showCalculationMethods(currentExamType);
        }

        function showCalculationMethods(type) {
            const methodDiv = document.getElementById('calculation-method');
            const optionsDiv = document.getElementById('method-options');
            
            if (currentAbsenceReason === 'unapproved') {
                methodDiv.classList.add('hidden');
                currentMethod = 'no-score';
                showInputForm(type, 'no-score');
                return;
            }
            
            methodDiv.classList.remove('hidden');
            optionsDiv.innerHTML = '';

            let methods = [];
            
            if (type === 'midterm') {
                methods = [
                    { id: 'final-score', label: 'ê¸°ë§ê³ ì‚¬ ì„±ì  ìˆìŒ', desc: 'ê¸°ë§ê³ ì‚¬ ì ìˆ˜ë¡œ ì¤‘ê°„ê³ ì‚¬ ì¸ì •ì  ê³„ì‚°' },
                    { id: 'performance-only', label: 'ìˆ˜í–‰í‰ê°€ ì„±ì  ìˆìŒ', desc: 'ìˆ˜í–‰í‰ê°€ ì ìˆ˜ë¡œ ì¤‘ê°„ê³ ì‚¬ ì¸ì •ì  ê³„ì‚°' },
                    { id: 'no-score', label: 'ì„±ì  ì—†ìŒ', desc: 'ì¤‘ê°„ê³ ì‚¬ ìµœí•˜ì -1ì  ì ìš©' }
                ];
            } else if (type === 'final') {
                methods = [
                    { id: 'midterm-score', label: 'ì¤‘ê°„ê³ ì‚¬ ì„±ì  ìˆìŒ', desc: 'ì¤‘ê°„ê³ ì‚¬ ì ìˆ˜ë¡œ ê¸°ë§ê³ ì‚¬ ì¸ì •ì  ê³„ì‚°' },
                    { id: 'performance-only', label: 'ìˆ˜í–‰í‰ê°€ ì„±ì  ìˆìŒ', desc: 'ìˆ˜í–‰í‰ê°€ ì ìˆ˜ë¡œ ê¸°ë§ê³ ì‚¬ ì¸ì •ì  ê³„ì‚°' },
                    { id: 'no-score', label: 'ì„±ì  ì—†ìŒ', desc: 'ê¸°ë§ê³ ì‚¬ ìµœí•˜ì -1ì  ì ìš©' }
                ];
            } else if (type === 'english-listening') {
                methods = [
                    { id: 'written-exam', label: 'ì§€í•„ê³ ì‚¬ ì„±ì  ìˆìŒ', desc: 'ì˜ì–´ ì§€í•„í‰ê°€ ì ìˆ˜ë¡œ ê³„ì‚°' },
                    { id: 'performance-only', label: 'ìˆ˜í–‰í‰ê°€ë§Œ ìˆìŒ', desc: 'ë‹¤ë¥¸ ìˆ˜í–‰í‰ê°€ ì ìˆ˜ë¡œ ê³„ì‚°' },
                    { id: 'no-score', label: 'ì„±ì  ì—†ìŒ', desc: 'ì˜ì–´ë“£ê¸° ìµœí•˜ì -1ì  ì ìš©' }
                ];
            } else {
                if (isPerformanceOnlySubject) {
                    methods = [
                        { id: 'other-performance', label: 'ë‹¤ë¥¸ ìˆ˜í–‰í‰ê°€ ì ìˆ˜ ìˆìŒ', desc: 'ë‹¤ë¥¸ ì˜ì—­ ìˆ˜í–‰í‰ê°€ë¡œ ê³„ì‚°' },
                        { id: 'no-score', label: 'ì„±ì  ì—†ìŒ', desc: 'ìˆ˜í–‰í‰ê°€ ìµœí•˜ì -1ì  ì ìš©' }
                    ];
                } else {
                    methods = [
                        { id: 'other-performance', label: 'ë‹¤ë¥¸ ìˆ˜í–‰í‰ê°€ ì ìˆ˜ ìˆìŒ', desc: 'ë‹¤ë¥¸ ì˜ì—­ ìˆ˜í–‰í‰ê°€ë¡œ ê³„ì‚°' },
                        { id: 'written-exam', label: 'ì§€í•„í‰ê°€ ì ìˆ˜ ìˆìŒ', desc: 'ì¤‘ê°„/ê¸°ë§ê³ ì‚¬ ì ìˆ˜ë¡œ ê³„ì‚°' },
                        { id: 'no-score', label: 'ì„±ì  ì—†ìŒ', desc: 'ìˆ˜í–‰í‰ê°€ ìµœí•˜ì -1ì  ì ìš©' }
                    ];
                }
            }

            methods.forEach((method, index) => {
                const methodBtn = document.createElement('div');
                methodBtn.className = 'method-option border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-300 hover:bg-blue-50 transition-all duration-200';
                methodBtn.onclick = () => selectMethod(method.id);
                methodBtn.innerHTML = `
                    <div class="flex items-center">
                        <div class="flex-shrink-0 w-8 h-8 bg-blue-100 text-blue-800 rounded-full flex items-center justify-center font-bold text-sm mr-3">
                            ${index + 1}
                        </div>
                        <div>
                            <div class="font-medium text-gray-800">${method.label}</div>
                            <div class="text-sm text-gray-600">${method.desc}</div>
                        </div>
                    </div>
                `;
                optionsDiv.appendChild(methodBtn);
            });
        }

        function selectMethod(method) {
            currentMethod = method;
            
            document.querySelectorAll('.method-option').forEach(option => {
                option.classList.remove('border-blue-500', 'bg-blue-50');
                option.classList.add('border-gray-200');
            });
            
            event.currentTarget.classList.add('border-blue-500', 'bg-blue-50');
            event.currentTarget.classList.remove('border-gray-200');

            showInputForm(currentExamType, method);
        }

        function showInputForm(examType, method) {
            const formDiv = document.getElementById('input-form');
            const fieldsDiv = document.getElementById('input-fields');
            
            formDiv.classList.remove('hidden');
            fieldsDiv.innerHTML = '';

            let fields = [];

            if (examType === 'english-listening') {
                if (method === 'written-exam') {
                    fields = [
                        { id: 'student-midterm-score', label: 'í•´ë‹¹ í•™ìƒì˜ ì¤‘ê°„ê³ ì‚¬ ì ìˆ˜', placeholder: 'ì˜ˆ: 82 (ì—†ìœ¼ë©´ 0)', description: 'í•´ë‹¹ í•™ìƒì´ ì¤‘ê°„ê³ ì‚¬ì—ì„œ ë°›ì€ ì ìˆ˜ (ì‘ì‹œí•˜ì§€ ì•Šì•˜ìœ¼ë©´ 0 ì…ë ¥)' },
                        { id: 'student-final-score', label: 'í•´ë‹¹ í•™ìƒì˜ ê¸°ë§ê³ ì‚¬ ì ìˆ˜', placeholder: 'ì˜ˆ: 88 (ì—†ìœ¼ë©´ 0)', description: 'í•´ë‹¹ í•™ìƒì´ ê¸°ë§ê³ ì‚¬ì—ì„œ ë°›ì€ ì ìˆ˜ (ì‘ì‹œí•˜ì§€ ì•Šì•˜ìœ¼ë©´ 0 ì…ë ¥)' },
                        { id: 'midterm-avg', label: 'ì „ì²´ í•™ìƒì˜ ì¤‘ê°„ê³ ì‚¬ í‰ê· ', placeholder: 'ì˜ˆ: 75.5 (ì—†ìœ¼ë©´ 0)', description: 'ì „ì²´ í•™ìƒë“¤ì˜ ì¤‘ê°„ê³ ì‚¬ í‰ê· ì ìˆ˜ (ì‹¤ì‹œí•˜ì§€ ì•Šì•˜ìœ¼ë©´ 0 ì…ë ¥)', autoFill: 'midterm-avg-input' },
                        { id: 'final-avg', label: 'ì „ì²´ í•™ìƒì˜ ê¸°ë§ê³ ì‚¬ í‰ê· ', placeholder: 'ì˜ˆ: 78.2 (ì—†ìœ¼ë©´ 0)', description: 'ì „ì²´ í•™ìƒë“¤ì˜ ê¸°ë§ê³ ì‚¬ í‰ê· ì ìˆ˜ (ì‹¤ì‹œí•˜ì§€ ì•Šì•˜ìœ¼ë©´ 0 ì…ë ¥)', autoFill: 'final-avg-input' },
                        { id: 'listening-avg', label: 'ì „ì²´ í•™ìƒì˜ ì˜ì–´ë“£ê¸°í‰ê°€ í‰ê·  ì ìˆ˜', placeholder: 'ì˜ˆ: 82.5', autoFill: 'listening-avg-input' }
                    ];
                } else if (method === 'performance-only') {
                    fields = [
                        { id: 'student-performance-areas-listening', label: 'í•™ìƒì´ ì‘ì‹œí•œ ì˜ì–´ ìˆ˜í–‰í‰ê°€ ì ìˆ˜ë“¤', type: 'dropdown-performance-listening', description: 'í•™ìƒì´ ì‹¤ì œë¡œ ì‘ì‹œí•œ ì˜ì–´ ìˆ˜í–‰í‰ê°€ ì˜ì—­ì„ ì„ íƒí•˜ì—¬ ì ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ì–´ë“£ê¸° ì œì™¸)' },
                        { id: 'listening-avg', label: 'ì „ì²´ í•™ìƒì˜ ì˜ì–´ë“£ê¸°í‰ê°€ í‰ê·  ì ìˆ˜', placeholder: 'ì˜ˆ: 82.5', autoFill: 'listening-avg-input' },
                        { id: 'perf-excluding-listening-avg', label: 'ì˜ì–´ë“£ê¸° ì œì™¸í•œ ìˆ˜í–‰í‰ê°€ ì˜ì—­ì˜ í‰ê· ì ìˆ˜', placeholder: 'ìë™ ê³„ì‚°ë¨', readonly: true }
                    ];
                } else if (method === 'no-score') {
                    fields = [
                        { id: 'listening-min', label: 'ì˜ì–´ë“£ê¸° í‰ê°€ ìµœí•˜ì ', placeholder: 'ì˜ˆ: 40', autoFill: 'listening-min-input' }
                    ];
                }
            } else if (examType === 'midterm') {
                if (method === 'final-score') {
                    fields = [
                        { id: 'midterm-avg', label: 'ì¤‘ê°„ê³ ì‚¬ í‰ê· ', placeholder: 'ì˜ˆ: 75.5', autoFill: 'midterm-avg-input' },
                        { id: 'final-score', label: 'ê¸°ë§ê³ ì‚¬ ì ìˆ˜', placeholder: 'ì˜ˆ: 85' },
                        { id: 'final-avg', label: 'ê¸°ë§ê³ ì‚¬ í‰ê· ', placeholder: 'ì˜ˆ: 78.2', autoFill: 'final-avg-input' }
                    ];
                } else if (method === 'performance-only') {
                    fields = [
                        { id: 'midterm-avg', label: 'ì¤‘ê°„ê³ ì‚¬ í‰ê· ', placeholder: 'ì˜ˆ: 75.5', autoFill: 'midterm-avg-input' },
                        { id: 'student-performance-areas', label: 'í•™ìƒì´ ì‘ì‹œí•œ ìˆ˜í–‰í‰ê°€ ì ìˆ˜ë“¤', type: 'dropdown-performance', description: 'í•™ìƒì´ ì‹¤ì œë¡œ ì‘ì‹œí•œ ìˆ˜í–‰í‰ê°€ ì˜ì—­ì„ ë“œë¡­ë‹¤ìš´ì—ì„œ ì„ íƒí•˜ì—¬ ì ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”' }
                    ];
                } else if (method === 'no-score') {
                    fields = [
                        { id: 'midterm-min', label: 'ì¤‘ê°„ê³ ì‚¬ ìµœí•˜ì ', placeholder: 'ì˜ˆ: 40', autoFill: 'midterm-min-input' }
                    ];
                }
            } else if (examType === 'final') {
                if (method === 'midterm-score') {
                    fields = [
                        { id: 'final-avg', label: 'ê¸°ë§ê³ ì‚¬ í‰ê· ', placeholder: 'ì˜ˆ: 78.2', autoFill: 'final-avg-input' },
                        { id: 'midterm-score', label: 'ì¤‘ê°„ê³ ì‚¬ ì ìˆ˜', placeholder: 'ì˜ˆ: 82' },
                        { id: 'midterm-avg', label: 'ì¤‘ê°„ê³ ì‚¬ í‰ê· ', placeholder: 'ì˜ˆ: 75.5', autoFill: 'midterm-avg-input' }
                    ];
                } else if (method === 'performance-only') {
                    fields = [
                        { id: 'final-avg', label: 'ê¸°ë§ê³ ì‚¬ í‰ê· ', placeholder: 'ì˜ˆ: 78.2', autoFill: 'final-avg-input' },
                        { id: 'student-performance-areas', label: 'í•™ìƒì´ ì‘ì‹œí•œ ìˆ˜í–‰í‰ê°€ ì ìˆ˜ë“¤', type: 'dropdown-performance', description: 'í•™ìƒì´ ì‹¤ì œë¡œ ì‘ì‹œí•œ ìˆ˜í–‰í‰ê°€ ì˜ì—­ì„ ë“œë¡­ë‹¤ìš´ì—ì„œ ì„ íƒí•˜ì—¬ ì ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”' }
                    ];
                } else if (method === 'no-score') {
                    fields = [
                        { id: 'final-min', label: 'ê¸°ë§ê³ ì‚¬ ìµœí•˜ì ', placeholder: 'ì˜ˆ: 40', autoFill: 'final-min-input' }
                    ];
                }
            } else if (examType === 'performance') {
                if (method === 'other-performance') {
                    fields = [
                        { id: 'absent-performance-area', label: 'ê²°ì‹œí•œ ìˆ˜í–‰í‰ê°€ ì˜ì—­ëª…', placeholder: 'ë“œë¡­ë‹¤ìš´ì—ì„œ ì„ íƒ', type: 'dropdown' },
                        { id: 'absent-performance-avg', label: 'ê²°ì‹œí•œ ì˜ì—­ì˜ ì „ì²´ í•™ìƒ í‰ê· ', placeholder: 'ìë™ ì…ë ¥ë¨', readonly: true },
                        { id: 'performance-area1', label: 'ì‘ì‹œí•œ ìˆ˜í–‰í‰ê°€ 1ì˜ì—­', type: 'performance-area', areaNum: 1 },
                        { id: 'performance-area2', label: 'ì‘ì‹œí•œ ìˆ˜í–‰í‰ê°€ 2ì˜ì—­ (ì„ íƒ)', type: 'performance-area', areaNum: 2, optional: true },
                        { id: 'performance-area3', label: 'ì‘ì‹œí•œ ìˆ˜í–‰í‰ê°€ 3ì˜ì—­ (ì„ íƒ)', type: 'performance-area', areaNum: 3, optional: true }
                    ];
                } else if (method === 'written-exam') {
                    fields = [
                        { id: 'absent-performance-area', label: 'ê²°ì‹œí•œ ìˆ˜í–‰í‰ê°€ ì˜ì—­ëª…', placeholder: 'ë“œë¡­ë‹¤ìš´ì—ì„œ ì„ íƒ', type: 'dropdown' },
                        { id: 'absent-performance-avg', label: 'ê²°ì‹œí•œ ì˜ì—­ì˜ ì „ì²´ í•™ìƒ í‰ê· ', placeholder: 'ìë™ ì…ë ¥ë¨', readonly: true },
                        { id: 'midterm-score', label: 'í•´ë‹¹ í•™ìƒì˜ ì¤‘ê°„ê³ ì‚¬ ì ìˆ˜', placeholder: 'ì˜ˆ: 82 (ì—†ìœ¼ë©´ 0)', description: 'í•´ë‹¹ í•™ìƒì´ ì¤‘ê°„ê³ ì‚¬ì—ì„œ ë°›ì€ ì ìˆ˜ (ì‘ì‹œí•˜ì§€ ì•Šì•˜ìœ¼ë©´ 0 ì…ë ¥)' },
                        { id: 'midterm-avg', label: 'ì „ì²´ í•™ìƒì˜ ì¤‘ê°„ê³ ì‚¬ í‰ê· ', placeholder: 'ì˜ˆ: 75.5 (ì—†ìœ¼ë©´ 0)', description: 'ì „ì²´ í•™ìƒë“¤ì˜ ì¤‘ê°„ê³ ì‚¬ í‰ê· ì ìˆ˜ (ì‹¤ì‹œí•˜ì§€ ì•Šì•˜ìœ¼ë©´ 0 ì…ë ¥)', autoFill: 'midterm-avg-input' },
                        { id: 'final-score', label: 'í•´ë‹¹ í•™ìƒì˜ ê¸°ë§ê³ ì‚¬ ì ìˆ˜', placeholder: 'ì˜ˆ: 85 (ì—†ìœ¼ë©´ 0)', description: 'í•´ë‹¹ í•™ìƒì´ ê¸°ë§ê³ ì‚¬ì—ì„œ ë°›ì€ ì ìˆ˜ (ì‘ì‹œí•˜ì§€ ì•Šì•˜ìœ¼ë©´ 0 ì…ë ¥)' },
                        { id: 'final-avg', label: 'ì „ì²´ í•™ìƒì˜ ê¸°ë§ê³ ì‚¬ í‰ê· ', placeholder: 'ì˜ˆ: 78.2 (ì—†ìœ¼ë©´ 0)', description: 'ì „ì²´ í•™ìƒë“¤ì˜ ê¸°ë§ê³ ì‚¬ í‰ê· ì ìˆ˜ (ì‹¤ì‹œí•˜ì§€ ì•Šì•˜ìœ¼ë©´ 0 ì…ë ¥)', autoFill: 'final-avg-input' }
                    ];
                } else if (method === 'no-score') {
                    fields = [
                        { id: 'absent-performance-area', label: 'ê²°ì‹œí•œ ìˆ˜í–‰í‰ê°€ ì˜ì—­ëª…', placeholder: 'ë“œë¡­ë‹¤ìš´ì—ì„œ ì„ íƒ', type: 'dropdown' },
                        { id: 'performance-min', label: 'ìˆ˜í–‰í‰ê°€ ìµœí•˜ì ', placeholder: 'ìë™ ì…ë ¥ë¨', readonly: true }
                    ];
                }
            }

            fields.forEach(field => {
                const fieldDiv = document.createElement('div');
                
                let descriptionHtml = '';
                if (field.description) {
                    descriptionHtml = `<p class="text-xs text-gray-500 mt-1">${field.description}</p>`;
                }
                
                let inputHtml = '';
                if (field.type === 'performance-area') {
                    // ìˆ˜í–‰í‰ê°€ ì˜ì—­ í•„ë“œ (ì˜ì—­ëª… ì„ íƒ + í•™ìƒ ì ìˆ˜ ì…ë ¥)
                    inputHtml = `
                        <div class="grid grid-cols-3 gap-2">
                            <select id="area-select-${field.areaNum}" onchange="updateAreaAverage(${field.areaNum})" 
                                    class="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200">
                                <option value="">ì˜ì—­ ì„ íƒ</option>
                            </select>
                            <input type="number" step="0.1" id="student-performance-area${field.areaNum}" placeholder="í•™ìƒ ì ìˆ˜" 
                                   class="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200">
                            <input type="number" step="0.1" id="class-performance-area${field.areaNum}" placeholder="ì „ì²´ í‰ê· " 
                                   readonly class="px-3 py-2 text-sm border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200">
                        </div>
                    `;
                } else if (field.type === 'dropdown') {
                    // ë“œë¡­ë‹¤ìš´ í•„ë“œ
                    inputHtml = `
                        <div class="grid grid-cols-2 gap-2">
                            <select id="${field.id}" onchange="updatePerformanceAverage()" 
                                    class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                                <option value="">ì˜ì—­ ì„ íƒ</option>
                            </select>
                            <input type="number" step="0.1" id="${field.id.replace('area', 'avg')}" placeholder="ìë™ ì…ë ¥ë¨" 
                                   readonly class="px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                        </div>
                    `;
                } else if (field.type === 'dropdown-performance') {
                    // ë“œë¡­ë‹¤ìš´ ì„ íƒí˜• ìˆ˜í–‰í‰ê°€ ì ìˆ˜ ì…ë ¥ í•„ë“œ
                    inputHtml = `
                        <div id="dropdown-performance-container" class="space-y-3">
                            <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                        </div>
                        <div class="mt-3 flex gap-2">
                            <button type="button" onclick="addDropdownPerformanceField()" 
                                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-all duration-200">
                                + ì˜ì—­ ì¶”ê°€
                            </button>
                        </div>
                        <div class="mt-3 p-3 bg-blue-50 rounded-lg">
                            <div class="text-sm text-blue-800 font-medium">ê³„ì‚°ëœ í•™ìƒ ìˆ˜í–‰í‰ê°€ í‰ê· </div>
                            <input type="number" step="0.1" id="calculated-student-performance-avg" readonly 
                                   class="w-full mt-2 px-3 py-2 text-sm border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                        </div>
                    `;
                } else if (field.type === 'dropdown-performance-listening') {
                    // ì˜ì–´ë“£ê¸°ìš© ë“œë¡­ë‹¤ìš´ ì„ íƒí˜• ìˆ˜í–‰í‰ê°€ ì ìˆ˜ ì…ë ¥ í•„ë“œ
                    inputHtml = `
                        <div id="dropdown-performance-listening-container" class="space-y-3">
                            <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                        </div>
                        <div class="mt-3 flex gap-2">
                            <button type="button" onclick="addDropdownPerformanceListeningField()" 
                                    class="px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg text-sm font-medium transition-all duration-200">
                                + ì˜ì—­ ì¶”ê°€
                            </button>
                        </div>
                        <div class="mt-3 p-3 bg-orange-50 rounded-lg">
                            <div class="text-sm text-orange-800 font-medium">ê³„ì‚°ëœ í•™ìƒ ì˜ì–´ ìˆ˜í–‰í‰ê°€ í‰ê·  (ì˜ì–´ë“£ê¸° ì œì™¸)</div>
                            <input type="number" step="0.1" id="calculated-student-listening-performance-avg" readonly 
                                   class="w-full mt-2 px-3 py-2 text-sm border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all duration-200">
                        </div>
                    `;
                } else if (field.readonly) {
                    // ì½ê¸° ì „ìš© í•„ë“œ
                    inputHtml = `
                        <input type="number" step="0.1" id="${field.id}" placeholder="${field.placeholder}" 
                               readonly class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    `;
                } else {
                    // ì¼ë°˜ ì…ë ¥ í•„ë“œ
                    let inputType = field.id.includes('score') || field.id.includes('avg') || field.id.includes('min') ? 'number' : 'text';
                    let stepAttr = inputType === 'number' ? 'step="0.1"' : '';
                    
                    inputHtml = `
                        <input type="${inputType}" ${stepAttr} id="${field.id}" placeholder="${field.placeholder}" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    `;
                }
                
                fieldDiv.innerHTML = `
                    <label class="block text-sm font-medium text-gray-700 mb-2">${field.label}</label>
                    ${inputHtml}
                    ${descriptionHtml}
                `;
                
                fieldsDiv.appendChild(fieldDiv);
                
                // ë“œë¡­ë‹¤ìš´ì¸ ê²½ìš° ì˜µì…˜ ì¶”ê°€
                if (field.type === 'dropdown') {
                    populatePerformanceDropdown(field.id);
                } else if (field.type === 'performance-area') {
                    populateAreaDropdown(field.areaNum);
                } else if (field.type === 'dropdown-performance') {
                    populateDropdownPerformanceFields();
                } else if (field.type === 'dropdown-performance-listening') {
                    populateDropdownPerformanceListeningFields();
                }
                
                // ìë™ ì±„ìš°ê¸° ì‹¤í–‰
                if (field.autoFill) {
                    setTimeout(() => {
                        autoFillField(field.id, field.autoFill);
                    }, 100);
                }
                
                // ì˜ì–´ë“£ê¸° ì œì™¸ ìˆ˜í–‰í‰ê°€ í‰ê·  ìë™ ê³„ì‚°
                if (field.id === 'perf-excluding-listening-avg') {
                    setTimeout(() => {
                        updatePerformanceExcludingListeningInForm();
                    }, 200);
                }
            });
        }

        // ë“œë¡­ë‹¤ìš´ ìˆ˜í–‰í‰ê°€ í•„ë“œ ê´€ë ¨ ë³€ìˆ˜
        let dropdownPerformanceCounter = 0;
        let dropdownPerformanceListeningCounter = 0;

        function populateDropdownPerformanceFields() {
            const container = document.getElementById('dropdown-performance-container');
            if (!container) return;
            
            // ì²« ë²ˆì§¸ í•„ë“œ ìë™ ì¶”ê°€
            if (dropdownPerformanceCounter === 0) {
                addDropdownPerformanceField();
            }
        }

        function populateDropdownPerformanceListeningFields() {
            const container = document.getElementById('dropdown-performance-listening-container');
            if (!container) return;
            
            // ì²« ë²ˆì§¸ í•„ë“œ ìë™ ì¶”ê°€
            if (dropdownPerformanceListeningCounter === 0) {
                addDropdownPerformanceListeningField();
            }
        }

        function addDropdownPerformanceField() {
            dropdownPerformanceCounter++;
            const container = document.getElementById('dropdown-performance-container');
            
            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'grid grid-cols-4 gap-2 items-center';
            fieldDiv.id = `dropdown-perf-field-${dropdownPerformanceCounter}`;
            
            fieldDiv.innerHTML = `
                <select id="dropdown-perf-select-${dropdownPerformanceCounter}" onchange="updateDropdownPerformanceAverage(${dropdownPerformanceCounter})" 
                        class="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">ì˜ì—­ ì„ íƒ</option>
                </select>
                <input type="number" step="0.1" id="dropdown-perf-student-${dropdownPerformanceCounter}" placeholder="í•™ìƒ ì ìˆ˜" 
                       oninput="calculateDropdownPerformanceAverage()" 
                       class="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                <input type="number" step="0.1" id="dropdown-perf-class-${dropdownPerformanceCounter}" placeholder="ì „ì²´ í‰ê· " 
                       readonly class="px-3 py-2 text-sm border border-gray-300 rounded-lg bg-gray-50">
                <button type="button" onclick="removeDropdownPerformanceField(${dropdownPerformanceCounter})" 
                        class="px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm transition-all duration-200">
                    ì‚­ì œ
                </button>
            `;
            
            container.appendChild(fieldDiv);
            populateDropdownOptions(dropdownPerformanceCounter);
        }

        function removeDropdownPerformanceField(fieldNum) {
            const field = document.getElementById(`dropdown-perf-field-${fieldNum}`);
            if (field) {
                field.remove();
                calculateDropdownPerformanceAverage();
            }
        }

        function populateDropdownOptions(fieldNum) {
            const grade = document.getElementById('student-grade').value;
            const subject = document.getElementById('student-subject').value;
            
            if (!grade || !subject) return;
            
            const dropdown = document.getElementById(`dropdown-perf-select-${fieldNum}`);
            
            if (!dropdown) return;
            
            // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì²« ë²ˆì§¸ ì˜µì…˜ ì œì™¸)
            while (dropdown.children.length > 1) {
                dropdown.removeChild(dropdown.lastChild);
            }
            
            // í‰ê·  ì ìˆ˜ ê´€ë¦¬ì—ì„œ ì…ë ¥ëœ ë°ì´í„° ì§ì ‘ ê°€ì ¸ì˜¤ê¸°
            const performanceAreas = [];
            
            for (let i = 1; i <= 4; i++) {
                const nameInput = document.getElementById(`perf${i}-name-input`);
                const avgInput = document.getElementById(`perf${i}-avg-input`);
                
                if (nameInput && avgInput && nameInput.value && avgInput.value) {
                    performanceAreas.push({
                        index: i,
                        name: nameInput.value,
                        avg: avgInput.value
                    });
                }
            }
            
            // ì˜ì–´ ê³¼ëª©ì¸ ê²½ìš° ì˜ì–´ë“£ê¸°ë„ ì¶”ê°€
            if (subject === 'ì˜ì–´') {
                const listeningAvgInput = document.getElementById('listening-avg-input');
                
                if (listeningAvgInput && listeningAvgInput.value) {
                    performanceAreas.push({
                        index: 'listening',
                        name: 'ì˜ì–´ë“£ê¸°',
                        avg: listeningAvgInput.value
                    });
                }
            }
            
            // ë“œë¡­ë‹¤ìš´ì— ì˜µì…˜ ì¶”ê°€
            performanceAreas.forEach(area => {
                const option = document.createElement('option');
                option.value = `${area.index}|${area.name}|${area.avg}`;
                option.textContent = area.name;
                dropdown.appendChild(option);
            });
        }

        function updateDropdownPerformanceAverage(fieldNum) {
            const dropdown = document.getElementById(`dropdown-perf-select-${fieldNum}`);
            const avgInput = document.getElementById(`dropdown-perf-class-${fieldNum}`);
            
            if (dropdown && dropdown.value) {
                const [index, name, avg] = dropdown.value.split('|');
                if (avgInput) {
                    avgInput.value = avg;
                }
            } else {
                if (avgInput) {
                    avgInput.value = '';
                }
            }
            
            calculateDropdownPerformanceAverage();
        }

        function addDropdownPerformanceListeningField() {
            dropdownPerformanceListeningCounter++;
            const container = document.getElementById('dropdown-performance-listening-container');
            
            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'grid grid-cols-4 gap-2 items-center';
            fieldDiv.id = `dropdown-listening-perf-field-${dropdownPerformanceListeningCounter}`;
            
            fieldDiv.innerHTML = `
                <select id="dropdown-listening-perf-select-${dropdownPerformanceListeningCounter}" onchange="updateDropdownListeningPerformanceAverage(${dropdownPerformanceListeningCounter})" 
                        class="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                    <option value="">ì˜ì—­ ì„ íƒ</option>
                </select>
                <input type="number" step="0.1" id="dropdown-listening-perf-student-${dropdownPerformanceListeningCounter}" placeholder="í•™ìƒ ì ìˆ˜" 
                       oninput="calculateDropdownListeningPerformanceAverage()" 
                       class="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                <input type="number" step="0.1" id="dropdown-listening-perf-class-${dropdownPerformanceListeningCounter}" placeholder="ì „ì²´ í‰ê· " 
                       readonly class="px-3 py-2 text-sm border border-gray-300 rounded-lg bg-gray-50">
                <button type="button" onclick="removeDropdownListeningPerformanceField(${dropdownPerformanceListeningCounter})" 
                        class="px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm transition-all duration-200">
                    ì‚­ì œ
                </button>
            `;
            
            container.appendChild(fieldDiv);
            populateDropdownListeningOptions(dropdownPerformanceListeningCounter);
        }

        function removeDropdownListeningPerformanceField(fieldNum) {
            const field = document.getElementById(`dropdown-listening-perf-field-${fieldNum}`);
            if (field) {
                field.remove();
                calculateDropdownListeningPerformanceAverage();
            }
        }

        function populateDropdownListeningOptions(fieldNum) {
            const grade = document.getElementById('student-grade').value;
            const subject = document.getElementById('student-subject').value;
            
            if (!grade || !subject) return;
            
            const dropdown = document.getElementById(`dropdown-listening-perf-select-${fieldNum}`);
            
            if (!dropdown) return;
            
            // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì²« ë²ˆì§¸ ì˜µì…˜ ì œì™¸)
            while (dropdown.children.length > 1) {
                dropdown.removeChild(dropdown.lastChild);
            }
            
            // í‰ê·  ì ìˆ˜ ê´€ë¦¬ì—ì„œ ì…ë ¥ëœ ë°ì´í„° ì§ì ‘ ê°€ì ¸ì˜¤ê¸° (ì˜ì–´ë“£ê¸° ì œì™¸)
            const performanceAreas = [];
            
            for (let i = 1; i <= 4; i++) {
                const nameInput = document.getElementById(`perf${i}-name-input`);
                const avgInput = document.getElementById(`perf${i}-avg-input`);
                
                if (nameInput && avgInput && nameInput.value && avgInput.value) {
                    performanceAreas.push({
                        index: i,
                        name: nameInput.value,
                        avg: avgInput.value
                    });
                }
            }
            
            // ë“œë¡­ë‹¤ìš´ì— ì˜µì…˜ ì¶”ê°€ (ì˜ì–´ë“£ê¸°ëŠ” ì œì™¸)
            performanceAreas.forEach(area => {
                const option = document.createElement('option');
                option.value = `${area.index}|${area.name}|${area.avg}`;
                option.textContent = area.name;
                dropdown.appendChild(option);
            });
        }

        function updateDropdownListeningPerformanceAverage(fieldNum) {
            const dropdown = document.getElementById(`dropdown-listening-perf-select-${fieldNum}`);
            const avgInput = document.getElementById(`dropdown-listening-perf-class-${fieldNum}`);
            
            if (dropdown && dropdown.value) {
                const [index, name, avg] = dropdown.value.split('|');
                if (avgInput) {
                    avgInput.value = avg;
                }
            } else {
                if (avgInput) {
                    avgInput.value = '';
                }
            }
            
            calculateDropdownListeningPerformanceAverage();
        }

        function calculateDropdownListeningPerformanceAverage() {
            let totalScore = 0;
            let count = 0;
            
            for (let i = 1; i <= dropdownPerformanceListeningCounter; i++) {
                const studentInput = document.getElementById(`dropdown-listening-perf-student-${i}`);
                if (studentInput && studentInput.value) {
                    const score = parseFloat(studentInput.value);
                    if (!isNaN(score)) {
                        totalScore += score;
                        count++;
                    }
                }
            }
            
            const avgInput = document.getElementById('calculated-student-listening-performance-avg');
            if (avgInput) {
                if (count > 0) {
                    avgInput.value = (totalScore / count).toFixed(2);
                } else {
                    avgInput.value = '';
                }
            }
        }

        function calculateDropdownPerformanceAverage() {
            let totalScore = 0;
            let count = 0;
            
            for (let i = 1; i <= dropdownPerformanceCounter; i++) {
                const studentInput = document.getElementById(`dropdown-perf-student-${i}`);
                if (studentInput && studentInput.value) {
                    const score = parseFloat(studentInput.value);
                    if (!isNaN(score)) {
                        totalScore += score;
                        count++;
                    }
                }
            }
            
            const avgInput = document.getElementById('calculated-student-performance-avg');
            if (avgInput) {
                if (count > 0) {
                    avgInput.value = (totalScore / count).toFixed(2);
                } else {
                    avgInput.value = '';
                }
            }
        }

        function calculateScore() {
            let result = 0;
            let reasonText = '';
            
            // ê²°ì‹œ ì‚¬ìœ ë³„ ì¸ì • ë¹„ìœ¨
            let recognitionRate = 1.0;
            if (currentAbsenceReason === 'sick') {
                recognitionRate = 0.8;
                reasonText = 'ë³‘ê²°';
            } else if (currentAbsenceReason === 'approved') {
                recognitionRate = 1.0;
                reasonText = 'ì¸ì •ê²°';
            } else if (currentAbsenceReason === 'unapproved') {
                reasonText = 'ë¯¸ì¸ì •ê²°';
            }
            
            try {
                // ì„±ì  ì—†ìŒ ì²˜ë¦¬ (ëª¨ë“  ê²°ì‹œ ì‚¬ìœ ì— ëŒ€í•´)
                if (currentMethod === 'no-score') {
                    let minScore = getMinScore(currentExamType, currentMethod);
                    
                    // ì €ì¥ëœ ìµœí•˜ì ì´ ì—†ìœ¼ë©´ ì…ë ¥ í•„ë“œì—ì„œ ê°€ì ¸ì˜¤ê¸°
                    if (!minScore) {
                        if (currentExamType === 'midterm') {
                            minScore = parseFloat(document.getElementById('midterm-min').value);
                        } else if (currentExamType === 'final') {
                            minScore = parseFloat(document.getElementById('final-min').value);
                        } else if (currentExamType === 'performance') {
                            const dropdown = document.getElementById('absent-performance-area');
                            if (dropdown && dropdown.value) {
                                minScore = parseFloat(document.getElementById('performance-min').value);
                            } else {
                                alert('ê²°ì‹œí•œ ìˆ˜í–‰í‰ê°€ ì˜ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                                return;
                            }
                        } else if (currentExamType === 'english-listening') {
                            minScore = parseFloat(document.getElementById('listening-min').value);
                        }
                    }
                    
                    if (isNaN(minScore) || minScore < 0) {
                        alert('ìµœí•˜ì ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    
                    let baseScore, finalScore;
                    
                    // ì„±ì ì´ ì—†ëŠ” ê²½ìš° ëª¨ë“  ê²°ì‹œ ì‚¬ìœ ì— ëŒ€í•´ ìµœí•˜ì ì˜ ì°¨í•˜ì  ì ìš©
                    if (minScore === 0) {
                        // ìµœí•˜ì ì´ 0ì ì¸ ê²½ìš°: ê¸°ì¤€ì  0ì , ì¸ì •ì  0ì  (0ì  í•˜í•œ ì ìš©)
                        baseScore = 0;
                        finalScore = 0;
                    } else {
                        // ìµœí•˜ì ì´ 0ì ì´ ì•„ë‹Œ ê²½ìš°: ê¸°ì¤€ì  ìµœí•˜ì , ì¸ì •ì  ìµœí•˜ì -1ì 
                        baseScore = minScore;
                        finalScore = minScore - 1;
                    }
                    
                    addResultToTable(baseScore, finalScore, reasonText);
                    resetForm();
                    return;
                } else {
                    // ì¼ë°˜ì ì¸ ê³„ì‚°
                    if (currentExamType === 'english-listening') {
                        if (currentMethod === 'written-exam') {
                            const studentMidtermScore = parseFloat(document.getElementById('student-midterm-score').value) || 0;
                            const studentFinalScore = parseFloat(document.getElementById('student-final-score').value) || 0;
                            const midtermAvg = parseFloat(document.getElementById('midterm-avg').value) || 0;
                            const finalAvg = parseFloat(document.getElementById('final-avg').value) || 0;
                            const listeningAvg = parseFloat(document.getElementById('listening-avg').value);
                            
                            // í•™ìƒì˜ ì§€í•„ê³ ì‚¬ í‰ê·  ê³„ì‚°
                            let studentWrittenAvg = 0;
                            let classWrittenAvg = 0;
                            
                            if (studentMidtermScore > 0 && studentFinalScore > 0) {
                                studentWrittenAvg = (studentMidtermScore + studentFinalScore) / 2;
                            } else if (studentMidtermScore > 0) {
                                studentWrittenAvg = studentMidtermScore;
                            } else if (studentFinalScore > 0) {
                                studentWrittenAvg = studentFinalScore;
                            }
                            
                            if (midtermAvg > 0 && finalAvg > 0) {
                                classWrittenAvg = (midtermAvg + finalAvg) / 2;
                            } else if (midtermAvg > 0) {
                                classWrittenAvg = midtermAvg;
                            } else if (finalAvg > 0) {
                                classWrittenAvg = finalAvg;
                            }
                            
                            if (studentWrittenAvg === 0 || classWrittenAvg === 0) {
                                alert('í•™ìƒì˜ ì§€í•„ê³ ì‚¬ ì ìˆ˜ì™€ ì „ì²´ í‰ê· ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                                return;
                            }
                            
                            const calculatedScore = (studentWrittenAvg / classWrittenAvg) * listeningAvg;
                            result = calculatedScore * recognitionRate;
                        } else if (currentMethod === 'performance-only') {
                            const studentPerfScore = parseFloat(document.getElementById('calculated-student-listening-performance-avg').value);
                            const listeningAvg = parseFloat(document.getElementById('listening-avg').value);
                            const perfExcludingListeningAvg = parseFloat(document.getElementById('perf-excluding-listening-avg').value);
                            
                            if (isNaN(studentPerfScore) || studentPerfScore === 0) {
                                alert('í•™ìƒì˜ ì˜ì–´ ìˆ˜í–‰í‰ê°€ ì ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                                return;
                            }
                            
                            const calculatedScore = studentPerfScore * (listeningAvg / perfExcludingListeningAvg);
                            result = calculatedScore * recognitionRate;
                        }
                    } else if (currentExamType === 'midterm') {
                        if (currentMethod === 'final-score') {
                            const midtermAvg = parseFloat(document.getElementById('midterm-avg').value);
                            const finalScore = parseFloat(document.getElementById('final-score').value);
                            const finalAvg = parseFloat(document.getElementById('final-avg').value);
                            
                            const calculatedScore = (finalScore / finalAvg) * midtermAvg;
                            result = calculatedScore * recognitionRate;
                        } else if (currentMethod === 'performance-only') {
                            const midtermAvg = parseFloat(document.getElementById('midterm-avg').value);
                            const performanceScore = parseFloat(document.getElementById('calculated-student-performance-avg').value);
                            
                            // ìˆ˜í–‰í‰ê°€ í‰ê· ì„ ìë™ìœ¼ë¡œ ê³„ì‚°
                            const performanceAvg = calculateClassPerformanceAverage();
                            
                            if (performanceAvg === 0) {
                                alert('ìˆ˜í–‰í‰ê°€ ì „ì²´ í‰ê· ì„ ê³„ì‚°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í‰ê·  ì ìˆ˜ ê´€ë¦¬ì—ì„œ ìˆ˜í–‰í‰ê°€ ì˜ì—­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                                return;
                            }
                            
                            const calculatedScore = (performanceScore / performanceAvg) * midtermAvg;
                            result = calculatedScore * recognitionRate;
                        }
                    } else if (currentExamType === 'final') {
                        if (currentMethod === 'midterm-score') {
                            const finalAvg = parseFloat(document.getElementById('final-avg').value);
                            const midtermScore = parseFloat(document.getElementById('midterm-score').value);
                            const midtermAvg = parseFloat(document.getElementById('midterm-avg').value);
                            
                            const calculatedScore = (midtermScore / midtermAvg) * finalAvg;
                            result = calculatedScore * recognitionRate;
                        } else if (currentMethod === 'performance-only') {
                            const finalAvg = parseFloat(document.getElementById('final-avg').value);
                            const performanceScore = parseFloat(document.getElementById('calculated-student-performance-avg').value);
                            
                            // ìˆ˜í–‰í‰ê°€ í‰ê· ì„ ìë™ìœ¼ë¡œ ê³„ì‚°
                            const performanceAvg = calculateClassPerformanceAverage();
                            
                            if (performanceAvg === 0) {
                                alert('ìˆ˜í–‰í‰ê°€ ì „ì²´ í‰ê· ì„ ê³„ì‚°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í‰ê·  ì ìˆ˜ ê´€ë¦¬ì—ì„œ ìˆ˜í–‰í‰ê°€ ì˜ì—­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                                return;
                            }
                            
                            const calculatedScore = (performanceScore / performanceAvg) * finalAvg;
                            result = calculatedScore * recognitionRate;
                        }
                    } else if (currentExamType === 'performance') {
                        if (currentMethod === 'other-performance') {
                            // ì—¬ëŸ¬ ìˆ˜í–‰í‰ê°€ ì˜ì—­ ì²˜ë¦¬
                            let studentScores = [];
                            let classAverages = [];
                            
                            // 1ì˜ì—­ì€ í•„ìˆ˜
                            const student1 = parseFloat(document.getElementById('student-performance-area1').value);
                            const class1 = parseFloat(document.getElementById('class-performance-area1').value);
                            
                            if (isNaN(student1) || isNaN(class1)) {
                                alert('1ì˜ì—­ ì ìˆ˜ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');
                                return;
                            }
                            
                            studentScores.push(student1);
                            classAverages.push(class1);
                            
                            // 2ì˜ì—­ (ì„ íƒ)
                            const student2 = parseFloat(document.getElementById('student-performance-area2').value);
                            const class2 = parseFloat(document.getElementById('class-performance-area2').value);
                            if (!isNaN(student2) && !isNaN(class2)) {
                                studentScores.push(student2);
                                classAverages.push(class2);
                            }
                            
                            // 3ì˜ì—­ (ì„ íƒ)
                            const student3 = parseFloat(document.getElementById('student-performance-area3').value);
                            const class3 = parseFloat(document.getElementById('class-performance-area3').value);
                            if (!isNaN(student3) && !isNaN(class3)) {
                                studentScores.push(student3);
                                classAverages.push(class3);
                            }
                            
                            const absentPerformanceAvg = parseFloat(document.getElementById('absent-performance-avg').value);
                            
                            if (isNaN(absentPerformanceAvg)) {
                                alert('ê²°ì‹œí•œ ìˆ˜í–‰í‰ê°€ ì˜ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                                return;
                            }
                            
                            // í‰ê·  ê³„ì‚°
                            const studentOtherPerformanceAvg = studentScores.reduce((a, b) => a + b, 0) / studentScores.length;
                            const classOtherPerformanceAvg = classAverages.reduce((a, b) => a + b, 0) / classAverages.length;
                            
                            const calculatedScore = studentOtherPerformanceAvg * (absentPerformanceAvg / classOtherPerformanceAvg);
                            result = calculatedScore * recognitionRate;
                        } else if (currentMethod === 'written-exam') {
                            const absentPerformanceAvg = parseFloat(document.getElementById('absent-performance-avg').value);
                            const midtermScore = parseFloat(document.getElementById('midterm-score').value) || 0;
                            const midtermAvg = parseFloat(document.getElementById('midterm-avg').value) || 0;
                            const finalScore = parseFloat(document.getElementById('final-score').value) || 0;
                            const finalAvg = parseFloat(document.getElementById('final-avg').value) || 0;
                            
                            if (isNaN(absentPerformanceAvg)) {
                                alert('ê²°ì‹œí•œ ìˆ˜í–‰í‰ê°€ ì˜ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                                return;
                            }
                            
                            // í•™ìƒì˜ ì§€í•„ê³ ì‚¬ í‰ê·  ê³„ì‚°
                            let studentWrittenAvg = 0;
                            let classWrittenAvg = 0;
                            
                            if (midtermScore > 0 && finalScore > 0) {
                                studentWrittenAvg = (midtermScore + finalScore) / 2;
                            } else if (midtermScore > 0) {
                                studentWrittenAvg = midtermScore;
                            } else if (finalScore > 0) {
                                studentWrittenAvg = finalScore;
                            }
                            
                            if (midtermAvg > 0 && finalAvg > 0) {
                                classWrittenAvg = (midtermAvg + finalAvg) / 2;
                            } else if (midtermAvg > 0) {
                                classWrittenAvg = midtermAvg;
                            } else if (finalAvg > 0) {
                                classWrittenAvg = finalAvg;
                            }
                            
                            if (studentWrittenAvg === 0 || classWrittenAvg === 0) {
                                alert('í•™ìƒì˜ ì§€í•„ê³ ì‚¬ ì ìˆ˜ì™€ ì „ì²´ í‰ê· ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                                return;
                            }
                            
                            const calculatedScore = (studentWrittenAvg / classWrittenAvg) * absentPerformanceAvg;
                            result = calculatedScore * recognitionRate;
                        }
                    }
                }

                let baseScore, finalScore;
                
                if (currentAbsenceReason === 'sick') {
                    baseScore = result / recognitionRate;
                    finalScore = result > 100 ? 100 : result;
                } else {
                    baseScore = result;
                    finalScore = result > 100 ? 100 : result;
                }
                
                // ê¸°ì¤€ì ì„ ì†Œìˆ˜ì  6ë²ˆì§¸ ìë¦¬ì—ì„œ ë°˜ì˜¬ë¦¼í•˜ì—¬ 5ë²ˆì§¸ ìë¦¬ê¹Œì§€ í‘œì‹œ
                result = Number((result + Number.EPSILON).toFixed(8));
                baseScore = Math.round(baseScore * 100000) / 100000;
                finalScore = Math.round(finalScore * 100) / 100;
                baseScore = parseFloat(baseScore.toFixed(5));
                addResultToTable(baseScore, finalScore, reasonText);
                resetForm();
                
            } catch (error) {
                alert('ì…ë ¥ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”. ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.');
            }
        }

        function addResultToTable(baseScore, finalScore, reasonText) {
            const studentGrade = document.getElementById('student-grade').value || '-';
            const studentClass = document.getElementById('student-class').value || '-';
            const studentNumber = document.getElementById('student-number').value || '-';
            const studentName = document.getElementById('student-name').value || '-';
            const studentSubject = document.getElementById('student-subject').value || '-';
            
            const examTypeText = currentExamType === 'midterm' ? 'ì§€í•„ê³ ì‚¬' : 
                               currentExamType === 'final' ? 'ì§€í•„ê³ ì‚¬' : 
                               currentExamType === 'english-listening' ? 'ìˆ˜í–‰í‰ê°€' : 'ìˆ˜í–‰í‰ê°€';
            
            let detailName = '';
            if (currentExamType === 'midterm') {
                detailName = 'ì¤‘ê°„ê³ ì‚¬';
            } else if (currentExamType === 'final') {
                detailName = 'ê¸°ë§ê³ ì‚¬';
            } else if (currentExamType === 'english-listening') {
                detailName = 'ì˜ì–´ë“£ê¸°';
            } else if (currentExamType === 'performance') {
                const dropdown = document.getElementById('absent-performance-area');
                if (dropdown && dropdown.value) {
                    const [index, name] = dropdown.value.split('|');
                    detailName = name;
                } else {
                    detailName = 'ìˆ˜í–‰í‰ê°€';
                }
            }
            
            resultCounter++;
            
            let recognitionRateText = '';
            if (currentMethod === 'no-score') {
                recognitionRateText = 'ìµœí•˜ì ì˜ ì°¨í•˜ì ';
            } else if (currentAbsenceReason === 'sick') {
                recognitionRateText = '80%';
            } else if (currentAbsenceReason === 'approved') {
                recognitionRateText = '100%';
            } else if (currentAbsenceReason === 'unapproved') {
                recognitionRateText = 'ìµœí•˜ì ì˜ ì°¨í•˜ì ';
            }
            
            // ê³„ì‚° ê¸°ì¤€ íŒë‹¨
            let calculationBasis = '';
            
            if (currentMethod === 'no-score') {
                calculationBasis = 'ì„±ì  ì—†ìŒ';
            } else if (currentExamType === 'midterm') {
                if (currentMethod === 'final-score') {
                    calculationBasis = 'ê¸°ë§ê³ ì‚¬';
                } else if (currentMethod === 'performance-only') {
                    calculationBasis = 'ìˆ˜í–‰í‰ê°€(ì „ì²´)';
                }
            } else if (currentExamType === 'final') {
                if (currentMethod === 'midterm-score') {
                    calculationBasis = 'ì¤‘ê°„ê³ ì‚¬';
                } else if (currentMethod === 'performance-only') {
                    calculationBasis = 'ìˆ˜í–‰í‰ê°€(ì „ì²´)';
                }
            } else if (currentExamType === 'performance') {
                if (currentMethod === 'other-performance') {
                    calculationBasis = 'ìˆ˜í–‰í‰ê°€(ë¶€ë¶„)';
                } else if (currentMethod === 'written-exam') {
                    calculationBasis = 'ì§€í•„ê³ ì‚¬';
                }
            } else if (currentExamType === 'english-listening') {
                if (currentMethod === 'written-exam') {
                    calculationBasis = 'ì§€í•„ê³ ì‚¬';
                } else if (currentMethod === 'performance-only') {
                    calculationBasis = 'ìˆ˜í–‰í‰ê°€(ë¶€ë¶„)';
                }
            }
            
            // ìµœí•˜ì  ì •ë³´ ìˆ˜ì§‘
            let minScoreValue = '';
            if (currentMethod === 'no-score') {
                if (currentExamType === 'midterm') {
                    const inputValue = document.getElementById('midterm-min');
                    minScoreValue = inputValue ? parseFloat(inputValue.value) : getMinScore('midterm');
                } else if (currentExamType === 'final') {
                    const inputValue = document.getElementById('final-min');
                    minScoreValue = inputValue ? parseFloat(inputValue.value) : getMinScore('final');
                } else if (currentExamType === 'performance') {
                    const inputValue = document.getElementById('performance-min');
                    minScoreValue = inputValue ? parseFloat(inputValue.value) : null;
                } else if (currentExamType === 'english-listening') {
                    const inputValue = document.getElementById('listening-min');
                    minScoreValue = inputValue ? parseFloat(inputValue.value) : getMinScore('english-listening');
                }
                
                // NaNì´ë©´ ë¹ˆ ë¬¸ìì—´ë¡œ ì²˜ë¦¬
                if (isNaN(minScoreValue)) {
                    minScoreValue = '';
                }
            }
            
            let remarksText = '';
            if (baseScore > 100) {
                remarksText = '100ì  ìƒí•œ ì ìš©';
            }
            
            // ê³„ì‚°ì— ì‚¬ìš©ëœ ìƒì„¸ ë°ì´í„° ìˆ˜ì§‘
            let calculationData = {
                attendedExams: [],
                attendedScores: [],
                attendedAverages: [],
                absentAverage: '',
                minScore: '',
                calculationFormula: ''
            };
            
            // ê³„ì‚° ë°©ì‹ë³„ë¡œ ìƒì„¸ ë°ì´í„° ìˆ˜ì§‘
            if (currentMethod !== 'no-score') {
                if (currentExamType === 'english-listening') {
                    if (currentMethod === 'written-exam') {
                        const studentMidtermScore = parseFloat(document.getElementById('student-midterm-score').value) || 0;
                        const studentFinalScore = parseFloat(document.getElementById('student-final-score').value) || 0;
                        const midtermAvg = parseFloat(document.getElementById('midterm-avg').value) || 0;
                        const finalAvg = parseFloat(document.getElementById('final-avg').value) || 0;
                        const listeningAvg = parseFloat(document.getElementById('listening-avg').value);
                        
                        if (studentMidtermScore > 0) {
                            calculationData.attendedExams.push('ì¤‘ê°„ê³ ì‚¬');
                            calculationData.attendedScores.push(studentMidtermScore);
                            calculationData.attendedAverages.push(midtermAvg);
                        }
                        if (studentFinalScore > 0) {
                            calculationData.attendedExams.push('ê¸°ë§ê³ ì‚¬');
                            calculationData.attendedScores.push(studentFinalScore);
                            calculationData.attendedAverages.push(finalAvg);
                        }
                        calculationData.absentAverage = listeningAvg;
                        calculationData.calculationFormula = '(í•™ìƒ ì§€í•„í‰ê·  Ã· ì „ì²´ ì§€í•„í‰ê· ) Ã— ì˜ì–´ë“£ê¸°í‰ê·  Ã— ì¸ì •ë¹„ìœ¨';
                    } else if (currentMethod === 'performance-only') {
                        // ì˜ì–´ë“£ê¸°ìš© ìˆ˜í–‰í‰ê°€ ë°ì´í„° ìˆ˜ì§‘
                        for (let i = 1; i <= dropdownPerformanceListeningCounter; i++) {
                            const dropdown = document.getElementById(`dropdown-listening-perf-select-${i}`);
                            const studentScore = document.getElementById(`dropdown-listening-perf-student-${i}`);
                            const classAvg = document.getElementById(`dropdown-listening-perf-class-${i}`);
                            
                            if (dropdown && dropdown.value && studentScore && studentScore.value) {
                                const [index, name] = dropdown.value.split('|');
                                calculationData.attendedExams.push(name);
                                calculationData.attendedScores.push(parseFloat(studentScore.value));
                                calculationData.attendedAverages.push(parseFloat(classAvg.value));
                            }
                        }
                        calculationData.absentAverage = parseFloat(document.getElementById('listening-avg').value);
                        calculationData.calculationFormula = 'í•™ìƒ ìˆ˜í–‰í‰ê°€í‰ê·  Ã— (ì˜ì–´ë“£ê¸°í‰ê·  Ã· ì˜ì–´ë“£ê¸°ì œì™¸ ìˆ˜í–‰í‰ê· ) Ã— ì¸ì •ë¹„ìœ¨';
                    }
                } else if (currentExamType === 'midterm') {
                    if (currentMethod === 'final-score') {
                        calculationData.attendedExams.push('ê¸°ë§ê³ ì‚¬');
                        calculationData.attendedScores.push(parseFloat(document.getElementById('final-score').value));
                        calculationData.attendedAverages.push(parseFloat(document.getElementById('final-avg').value));
                        calculationData.absentAverage = parseFloat(document.getElementById('midterm-avg').value);
                        calculationData.calculationFormula = '(ê¸°ë§ì ìˆ˜ Ã· ê¸°ë§í‰ê· ) Ã— ì¤‘ê°„í‰ê·  Ã— ì¸ì •ë¹„ìœ¨';
                    } else if (currentMethod === 'performance-only') {
                        // ë“œë¡­ë‹¤ìš´ ìˆ˜í–‰í‰ê°€ ë°ì´í„° ìˆ˜ì§‘
                        for (let i = 1; i <= dropdownPerformanceCounter; i++) {
                            const dropdown = document.getElementById(`dropdown-perf-select-${i}`);
                            const studentScore = document.getElementById(`dropdown-perf-student-${i}`);
                            const classAvg = document.getElementById(`dropdown-perf-class-${i}`);
                            
                            if (dropdown && dropdown.value && studentScore && studentScore.value) {
                                const [index, name] = dropdown.value.split('|');
                                calculationData.attendedExams.push(name);
                                calculationData.attendedScores.push(parseFloat(studentScore.value));
                                calculationData.attendedAverages.push(parseFloat(classAvg.value));
                            }
                        }
                        calculationData.absentAverage = parseFloat(document.getElementById('midterm-avg').value);
                        calculationData.calculationFormula = '(ìˆ˜í–‰ì ìˆ˜ Ã· ìˆ˜í–‰í‰ê· ) Ã— ì¤‘ê°„í‰ê·  Ã— ì¸ì •ë¹„ìœ¨';
                    }
                } else if (currentExamType === 'final') {
                    if (currentMethod === 'midterm-score') {
                        calculationData.attendedExams.push('ì¤‘ê°„ê³ ì‚¬');
                        calculationData.attendedScores.push(parseFloat(document.getElementById('midterm-score').value));
                        calculationData.attendedAverages.push(parseFloat(document.getElementById('midterm-avg').value));
                        calculationData.absentAverage = parseFloat(document.getElementById('final-avg').value);
                        calculationData.calculationFormula = '(ì¤‘ê°„ì ìˆ˜ Ã· ì¤‘ê°„í‰ê· ) Ã— ê¸°ë§í‰ê·  Ã— ì¸ì •ë¹„ìœ¨';
                    } else if (currentMethod === 'performance-only') {
                        // ë“œë¡­ë‹¤ìš´ ìˆ˜í–‰í‰ê°€ ë°ì´í„° ìˆ˜ì§‘
                        for (let i = 1; i <= dropdownPerformanceCounter; i++) {
                            const dropdown = document.getElementById(`dropdown-perf-select-${i}`);
                            const studentScore = document.getElementById(`dropdown-perf-student-${i}`);
                            const classAvg = document.getElementById(`dropdown-perf-class-${i}`);
                            
                            if (dropdown && dropdown.value && studentScore && studentScore.value) {
                                const [index, name] = dropdown.value.split('|');
                                calculationData.attendedExams.push(name);
                                calculationData.attendedScores.push(parseFloat(studentScore.value));
                                calculationData.attendedAverages.push(parseFloat(classAvg.value));
                            }
                        }
                        calculationData.absentAverage = parseFloat(document.getElementById('final-avg').value);
                        calculationData.calculationFormula = '(ìˆ˜í–‰ì ìˆ˜ Ã· ìˆ˜í–‰í‰ê· ) Ã— ê¸°ë§í‰ê·  Ã— ì¸ì •ë¹„ìœ¨';
                    }
                } else if (currentExamType === 'performance') {
                    if (currentMethod === 'other-performance') {
                        // ìˆ˜í–‰í‰ê°€ ì˜ì—­ë³„ ë°ì´í„° ìˆ˜ì§‘
                        for (let i = 1; i <= 3; i++) {
                            const dropdown = document.getElementById(`area-select-${i}`);
                            const studentScore = document.getElementById(`student-performance-area${i}`);
                            const classAvg = document.getElementById(`class-performance-area${i}`);
                            
                            if (dropdown && dropdown.value && studentScore && studentScore.value) {
                                const [index, name] = dropdown.value.split('|');
                                calculationData.attendedExams.push(name);
                                calculationData.attendedScores.push(parseFloat(studentScore.value));
                                calculationData.attendedAverages.push(parseFloat(classAvg.value));
                            }
                        }
                        calculationData.absentAverage = parseFloat(document.getElementById('absent-performance-avg').value);
                        calculationData.calculationFormula = 'í•™ìƒ ë‹¤ë¥¸ì˜ì—­í‰ê·  Ã— (ê²°ì‹œì˜ì—­í‰ê·  Ã· ë‹¤ë¥¸ì˜ì—­ì „ì²´í‰ê· ) Ã— ì¸ì •ë¹„ìœ¨';
                    } else if (currentMethod === 'written-exam') {
                        const midtermScore = parseFloat(document.getElementById('midterm-score').value) || 0;
                        const finalScore = parseFloat(document.getElementById('final-score').value) || 0;
                        const midtermAvg = parseFloat(document.getElementById('midterm-avg').value) || 0;
                        const finalAvg = parseFloat(document.getElementById('final-avg').value) || 0;
                        
                        if (midtermScore > 0) {
                            calculationData.attendedExams.push('ì¤‘ê°„ê³ ì‚¬');
                            calculationData.attendedScores.push(midtermScore);
                            calculationData.attendedAverages.push(midtermAvg);
                        }
                        if (finalScore > 0) {
                            calculationData.attendedExams.push('ê¸°ë§ê³ ì‚¬');
                            calculationData.attendedScores.push(finalScore);
                            calculationData.attendedAverages.push(finalAvg);
                        }
                        calculationData.absentAverage = parseFloat(document.getElementById('absent-performance-avg').value);
                        calculationData.calculationFormula = '(í•™ìƒ ì§€í•„í‰ê·  Ã· ì „ì²´ ì§€í•„í‰ê· ) Ã— ê²°ì‹œì˜ì—­í‰ê·  Ã— ì¸ì •ë¹„ìœ¨';
                    }
                }
            } else {
                // ì„±ì  ì—†ìŒì¸ ê²½ìš°
                if (currentExamType === 'midterm') {
                    calculationData.minScore = parseFloat(document.getElementById('midterm-min').value) || getMinScore('midterm');
                } else if (currentExamType === 'final') {
                    calculationData.minScore = parseFloat(document.getElementById('final-min').value) || getMinScore('final');
                } else if (currentExamType === 'performance') {
                    calculationData.minScore = parseFloat(document.getElementById('performance-min').value);
                } else if (currentExamType === 'english-listening') {
                    calculationData.minScore = parseFloat(document.getElementById('listening-min').value) || getMinScore('english-listening');
                }
                calculationData.calculationFormula = 'ìµœí•˜ì  - 1ì ';
            }

            const resultData = {
                id: resultCounter,
                grade: studentGrade,
                class: studentClass,
                number: studentNumber,
                name: studentName,
                subject: studentSubject,
                examType: examTypeText,
                detailName: detailName,
                absenceReason: reasonText,
                recognitionRate: recognitionRateText,
                calculationBasis: calculationBasis,
                minScore: minScoreValue,
                baseScore: Math.round(baseScore * 100000) / 100000,
                finalScore: Math.round(finalScore * 100) / 100,
                remarks: remarksText,
                calculationData: calculationData
            };
            resultsData.push(resultData);
            
            const tbody = document.getElementById('results-tbody');
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            row.id = `result-row-${resultCounter}`;
            
            const reasonClass = currentAbsenceReason === 'sick' ? 'bg-red-100 text-red-800' :
                              currentAbsenceReason === 'approved' ? 'bg-blue-100 text-blue-800' :
                              'bg-gray-100 text-gray-800';
            
            const baseScoreDisplay = baseScore > 100 ? 
                `<span class="text-orange-600 font-bold">${(Math.round(baseScore * 100000) / 100000).toFixed(5)}ì </span>` : 
                `<span class="text-blue-600">${(Math.round(baseScore * 100000) / 100000).toFixed(5)}ì </span>`;
            
            const finalScoreDisplay = baseScore > 100 ? 
                `<span class="text-green-800 font-bold">100.00ì </span>` : 
                `<span class="text-green-800 font-bold">${(Math.round(finalScore * 100) / 100).toFixed(2)}ì </span>`;
            
            const rateClass = currentAbsenceReason === 'sick' ? 'text-orange-600' :
                             currentAbsenceReason === 'approved' ? 'text-blue-600' :
                             'text-gray-600';
            
            // ê³„ì‚° ê¸°ì¤€ ìŠ¤íƒ€ì¼
            let calculationBasisClass = 'text-gray-700';
            if (calculationBasis === 'ì„±ì  ì—†ìŒ') {
                calculationBasisClass = 'text-red-600 font-medium';
            } else if (calculationBasis.includes('ì§€í•„ê³ ì‚¬') || calculationBasis.includes('ì¤‘ê°„ê³ ì‚¬') || calculationBasis.includes('ê¸°ë§ê³ ì‚¬')) {
                calculationBasisClass = 'text-blue-600 font-medium';
            } else if (calculationBasis.includes('ìˆ˜í–‰í‰ê°€')) {
                calculationBasisClass = 'text-purple-600 font-medium';
            }
            
            row.innerHTML = `
                <td class="border border-gray-300 px-3 py-2 text-center text-sm">${resultCounter}</td>
                <td class="border border-gray-300 px-3 py-2 text-center text-sm">${studentGrade}</td>
                <td class="border border-gray-300 px-3 py-2 text-center text-sm">${studentClass}</td>
                <td class="border border-gray-300 px-3 py-2 text-center text-sm">${studentNumber}</td>
                <td class="border border-gray-300 px-3 py-2 text-center text-sm">${studentName}</td>
                <td class="border border-gray-300 px-3 py-2 text-center text-sm">${studentSubject}</td>
                <td class="border border-gray-300 px-3 py-2 text-center text-sm">${examTypeText}</td>
                <td class="border border-gray-300 px-3 py-2 text-center text-sm">${detailName}</td>
                <td class="border border-gray-300 px-3 py-2 text-center text-sm">
                    <span class="px-2 py-1 rounded text-xs font-medium ${reasonClass}">
                        ${reasonText}
                    </span>
                </td>
                <td class="border border-gray-300 px-3 py-2 text-center text-sm">
                    <span class="font-medium ${rateClass}">${recognitionRateText}</span>
                </td>
                <td class="border border-gray-300 px-3 py-2 text-center text-sm">
                    <span class="text-xs ${calculationBasisClass}">${calculationBasis}</span>
                </td>
                <td class="border border-gray-300 px-3 py-2 text-center text-sm">
                    <span class="text-sm text-gray-700">${minScoreValue || '-'}</span>
                </td>
                <td class="border border-gray-300 px-3 py-2 text-center text-sm">${baseScoreDisplay}</td>
                <td class="border border-gray-300 px-3 py-2 text-center text-sm">${finalScoreDisplay}</td>
                <td class="border border-gray-300 px-3 py-2 text-center text-sm">
                    <span class="text-xs ${remarksText ? 'text-purple-600 font-medium' : 'text-gray-400'}">${remarksText || '-'}</span>
                </td>
                <td class="border border-gray-300 px-3 py-2 text-center text-sm">
                    <button type="button" onclick="deleteResult(${resultCounter})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition-all duration-200">
                        ì‚­ì œ
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
            
            const resultDiv = document.getElementById('result');
            resultDiv.classList.remove('hidden');
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function deleteResult(id) {
            resultsData = resultsData.filter(data => data.id !== id);
            
            const row = document.getElementById(`result-row-${id}`);
            if (row) {
                row.remove();
            }
            
            if (resultsData.length === 0) {
                document.getElementById('result').classList.add('hidden');
            }
        }

        function clearResults() {
            if (resultsData.length === 0) {
                alert('ì‚­ì œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (confirm('ëª¨ë“  ê²°ê³¼ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                resultsData = [];
                resultCounter = 0;
                document.getElementById('results-tbody').innerHTML = '';
                document.getElementById('result').classList.add('hidden');
                alert('ëª¨ë“  ê²°ê³¼ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        }

        function exportToExcelApproval() {
            if (resultsData.length === 0) {
                alert('ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // íŒŒì¼ëª… ìƒì„±
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const dateStr = `${year}${month}${day}`;
            
            // í•™ë…„ê³¼ ê³¼ëª© ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const grade = document.getElementById('student-grade').value || 'ì „ì²´';
            const subject = document.getElementById('student-subject').value || 'ì „ê³¼ëª©';
            
            const fileName = `2025í•™ë…„ë„_2í•™ê¸°_ì¸ì •ì ê³„ì‚°ê¸°_ê²°ì¬ìš©(${grade}í•™ë…„_${subject})_${dateStr}.xlsx`;
            
            // ì›Œí¬ì‹œíŠ¸ ë°ì´í„° ì¤€ë¹„
            const headers = ['ë²ˆí˜¸', 'í•™ë…„', 'ë°˜', 'í•™ë²ˆ', 'ì´ë¦„', 'ê³¼ëª©', 'ê²°ì‹œì‹œí—˜', 'ì„¸ë¶€ëª…', 'ê²°ì‹œì‚¬ìœ ', 'ì¸ì •ë¹„ìœ¨', 'ê³„ì‚° ê¸°ì¤€', 'ê¸°ì¤€ì ', 'ì¸ì •ì ', 'ë¹„ê³ '];
            const worksheetData = [headers];
            
            resultsData.forEach(data => {
                worksheetData.push([
                    data.id,
                    data.grade,
                    data.class,
                    data.number,
                    data.name,
                    data.subject,
                    data.examType,
                    data.detailName,
                    data.absenceReason,
                    data.recognitionRate,
                    data.calculationBasis,
                    (Math.round(data.baseScore * 100000) / 100000).toFixed(5),
                    typeof data.finalScore === 'number' ? data.finalScore.toFixed(2) : parseFloat(data.finalScore).toFixed(2),
                    data.remarks
                ]);
            });
            
            // XLSX íŒŒì¼ ìƒì„±
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
            
            // ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì •
            const colWidths = [
                { wch: 6 },   // ë²ˆí˜¸
                { wch: 6 },   // í•™ë…„
                { wch: 6 },   // ë°˜
                { wch: 6 },   // í•™ë²ˆ
                { wch: 10 },  // ì´ë¦„
                { wch: 8 },   // ê³¼ëª©
                { wch: 10 },  // ê²°ì‹œì‹œí—˜
                { wch: 12 },  // ì„¸ë¶€ëª…
                { wch: 10 },  // ê²°ì‹œì‚¬ìœ 
                { wch: 10 },  // ì¸ì •ë¹„ìœ¨
                { wch: 15 },  // ê³„ì‚° ê¸°ì¤€
                { wch: 10 },  // ê¸°ì¤€ì 
                { wch: 10 },  // ì¸ì •ì 
                { wch: 15 }   // ë¹„ê³ 
            ];
            worksheet['!cols'] = colWidths;
            
            // í—¤ë” ìŠ¤íƒ€ì¼ ì„¤ì •
            const headerRange = XLSX.utils.decode_range(worksheet['!ref']);
            for (let col = headerRange.s.c; col <= headerRange.e.c; col++) {
                const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
                if (!worksheet[cellAddress]) continue;
                worksheet[cellAddress].s = {
                    font: { bold: true, color: { rgb: "FFFFFF" } },
                    fill: { fgColor: { rgb: "4472C4" } },
                    alignment: { horizontal: "center", vertical: "center" }
                };
            }
            
            XLSX.utils.book_append_sheet(workbook, worksheet, "ì¸ì •ì ê³„ì‚°ê²°ê³¼");
            
            // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            XLSX.writeFile(workbook, fileName);
            
            alert(`ê²°ì¬ìš© ì—‘ì…€ íŒŒì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\níŒŒì¼ëª…: ${fileName}`);
        }

        function exportToExcelReview() {
            if (resultsData.length === 0) {
                alert('ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // íŒŒì¼ëª… ìƒì„±
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const dateStr = `${year}${month}${day}`;
            
            // í•™ë…„ê³¼ ê³¼ëª© ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const grade = document.getElementById('student-grade').value || 'ì „ì²´';
            const subject = document.getElementById('student-subject').value || 'ì „ê³¼ëª©';
            
            const fileName = `2025í•™ë…„ë„_2í•™ê¸°_ì¸ì •ì ê³„ì‚°ê¸°_í‰ê°€ê³„ê²€í† ìš©(${grade}í•™ë…„_${subject})_${dateStr}.xlsx`;
            
            // ìµœëŒ€ ì‘ì‹œ ì˜ì—­ ìˆ˜ ê³„ì‚° (ë™ì  ì»¬ëŸ¼ ìƒì„±ì„ ìœ„í•´)
            let maxAttendedAreas = 0;
            resultsData.forEach(data => {
                if (data.calculationData && data.calculationData.attendedExams) {
                    maxAttendedAreas = Math.max(maxAttendedAreas, data.calculationData.attendedExams.length);
                }
            });
            
            // ë™ì  í—¤ë” ìƒì„±
            const baseHeaders = [
                'ë²ˆí˜¸', 'í•™ë…„', 'ë°˜', 'í•™ë²ˆ', 'ì´ë¦„', 'ê³¼ëª©', 'ê²°ì‹œì‹œí—˜', 'ê²°ì‹œì‚¬ìœ ', 'ì¸ì •ë¹„ìœ¨', 'ê²°ì‹œì˜ì—­ëª…', 'ê²°ì‹œì˜ì—­í‰ê· ', 'ê³„ì‚° ê¸°ì¤€'
            ];
            
            // ê²°ì‹œ ì˜ì—­ í—¤ë”ëŠ” baseHeadersì— í¬í•¨ë¨
            const absentHeaders = [];
            
            // ì‘ì‹œ ì˜ì—­ í—¤ë” (ë™ì  ìƒì„±)
            const attendedHeaders = [];
            for (let i = 1; i <= maxAttendedAreas; i++) {
                attendedHeaders.push(`ì‘ì‹œì˜ì—­${i}ëª…`);
                attendedHeaders.push(`í‰ê· `);
                attendedHeaders.push(`í•™ìƒì ìˆ˜`);
            }
            
            const endHeaders = ['ìµœí•˜ì ', 'ê¸°ì¤€ì ', 'ì¸ì •ì ', 'ë¹„ê³ '];
            
            const reviewHeaders = [...baseHeaders, ...absentHeaders, ...attendedHeaders, ...endHeaders];
            const reviewWorksheetData = [reviewHeaders];
            
            resultsData.forEach(data => {
                // ê²°ì‹œ ì˜ì—­ ì •ë³´
                let absentAreaName = data.detailName || '';
                let absentAreaAvg = '';
                
                if (data.calculationData && data.calculationData.absentAverage) {
                    absentAreaAvg = data.calculationData.absentAverage;
                }
                
                const row = [
                    data.id,
                    data.grade,
                    data.class,
                    data.number,
                    data.name,
                    data.subject,
                    data.examType,
                    data.absenceReason,
                    data.recognitionRate,
                    absentAreaName,
                    absentAreaAvg,
                    data.calculationBasis
                ];
                
                // ì‘ì‹œ ì˜ì—­ ì •ë³´ (ë™ì ìœ¼ë¡œ ì±„ìš°ê¸°)
                const calcData = data.calculationData;
                if (calcData && calcData.attendedExams) {
                    for (let i = 0; i < maxAttendedAreas; i++) {
                        if (i < calcData.attendedExams.length) {
                            // í•´ë‹¹ ì˜ì—­ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°
                            row.push(
                                calcData.attendedExams[i] || '',           // ì˜ì—­ëª…
                                calcData.attendedAverages[i] || '',       // ì˜ì—­í‰ê· 
                                calcData.attendedScores[i] || ''          // í•™ìƒì ìˆ˜
                            );
                        } else {
                            // í•´ë‹¹ ì˜ì—­ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ë¹ˆ ì…€
                            row.push('', '', '');
                        }
                    }
                } else {
                    // ì‘ì‹œ ì˜ì—­ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ëª¨ë“  ì…€ì„ ë¹ˆ ê°’ìœ¼ë¡œ
                    for (let i = 0; i < maxAttendedAreas * 3; i++) {
                        row.push('');
                    }
                }
                
                // ë‚˜ë¨¸ì§€ ì •ë³´
                let minScore = '';
                
                if (data.minScore !== undefined && data.minScore !== '') {
                    minScore = data.minScore;
                } else if (calcData && calcData.minScore) {
                    minScore = calcData.minScore;
                }
                
                row.push(
                    minScore,
                    (Math.round(data.baseScore * 100000) / 100000).toFixed(5),
                    typeof data.finalScore === 'number' ? data.finalScore.toFixed(2) : parseFloat(data.finalScore).toFixed(2),
                    data.remarks
                );
                
                reviewWorksheetData.push(row);
            });
            
            // XLSX íŒŒì¼ ìƒì„±
            const workbook = XLSX.utils.book_new();
            const reviewWorksheet = XLSX.utils.aoa_to_sheet(reviewWorksheetData);
            
            // ë™ì  ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì •
            const reviewColWidths = [
                { wch: 6 },   // ë²ˆí˜¸
                { wch: 6 },   // í•™ë…„
                { wch: 6 },   // ë°˜
                { wch: 6 },   // í•™ë²ˆ
                { wch: 10 },  // ì´ë¦„
                { wch: 8 },   // ê³¼ëª©
                { wch: 10 },  // ê²°ì‹œì‹œí—˜
                { wch: 10 },  // ê²°ì‹œì‚¬ìœ 
                { wch: 10 },  // ì¸ì •ë¹„ìœ¨
                { wch: 12 },  // ê²°ì‹œì˜ì—­ëª…
                { wch: 10 },  // ê²°ì‹œì˜ì—­í‰ê· 
                { wch: 15 }   // ê³„ì‚° ê¸°ì¤€
            ];
            
            // ì‘ì‹œ ì˜ì—­ ì»¬ëŸ¼ ë„ˆë¹„ ì¶”ê°€
            for (let i = 0; i < maxAttendedAreas; i++) {
                reviewColWidths.push(
                    { wch: 12 },  // ì‘ì‹œì˜ì—­ëª…
                    { wch: 10 },  // ì‘ì‹œì˜ì—­í‰ê· 
                    { wch: 10 }   // ì‘ì‹œì˜ì—­í•™ìƒì ìˆ˜
                );
            }
            
            // ë‚˜ë¨¸ì§€ ì»¬ëŸ¼ ë„ˆë¹„ ì¶”ê°€
            reviewColWidths.push(
                { wch: 8 },   // ìµœí•˜ì 
                { wch: 12 },  // ê¸°ì¤€ì 
                { wch: 10 },  // ì¸ì •ì 
                { wch: 15 }   // ë¹„ê³ 
            );
            
            reviewWorksheet['!cols'] = reviewColWidths;
            
            // í—¤ë” ìŠ¤íƒ€ì¼ ì„¤ì •
            const reviewHeaderRange = XLSX.utils.decode_range(reviewWorksheet['!ref']);
            for (let col = reviewHeaderRange.s.c; col <= reviewHeaderRange.e.c; col++) {
                const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
                if (!reviewWorksheet[cellAddress]) continue;
                
                // í—¤ë” ìœ í˜•ë³„ ìƒ‰ìƒ êµ¬ë¶„
                let headerColor = "2E75B6"; // ê¸°ë³¸ íŒŒë€ìƒ‰
                const headerText = reviewWorksheet[cellAddress].v;
                
                if (headerText && headerText.includes('ê²°ì‹œ')) {
                    headerColor = "C5504B"; // ë¹¨ê°„ìƒ‰ (ê²°ì‹œ ê´€ë ¨)
                } else if (headerText && headerText.includes('ì‘ì‹œ')) {
                    headerColor = "70AD47"; // ì´ˆë¡ìƒ‰ (ì‘ì‹œ ê´€ë ¨)
                }
                
                reviewWorksheet[cellAddress].s = {
                    font: { bold: true, color: { rgb: "FFFFFF" } },
                    fill: { fgColor: { rgb: headerColor } },
                    alignment: { horizontal: "center", vertical: "center" }
                };
            }
            
            XLSX.utils.book_append_sheet(workbook, reviewWorksheet, "í‰ê°€ê³„ê²€í† ìš©");
            
            // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            XLSX.writeFile(workbook, fileName);
            
            alert(`í‰ê°€ê³„ ê²€í† ìš© ì—‘ì…€ íŒŒì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\níŒŒì¼ëª…: ${fileName}`);
        }

        function copyResults() {
            if (resultsData.length === 0) {
                alert('ë³µì‚¬í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const headers = ['ë²ˆí˜¸', 'í•™ë…„', 'ë°˜', 'í•™ë²ˆ', 'ì´ë¦„', 'ê³¼ëª©', 'ê²°ì‹œì‹œí—˜', 'ì„¸ë¶€ëª…', 'ê²°ì‹œì‚¬ìœ ', 'ì¸ì •ë¹„ìœ¨', 'ê³„ì‚° ê¸°ì¤€', 'ìµœí•˜ì ', 'ê¸°ì¤€ì ', 'ì¸ì •ì ', 'ë¹„ê³ '];
            let textContent = headers.join('\t') + '\n';
            
            resultsData.forEach(data => {
                let minScore = '';
                if (data.minScore !== undefined && data.minScore !== '') {
                    minScore = data.minScore;
                } else if (data.calculationData && data.calculationData.minScore) {
                    minScore = data.calculationData.minScore;
                }
                
                const row = [
                    data.id,
                    data.grade,
                    data.class,
                    data.number,
                    data.name,
                    data.subject,
                    data.examType,
                    data.detailName,
                    data.absenceReason,
                    data.recognitionRate,
                    data.calculationBasis,
                    minScore,
                    (Math.round(data.baseScore * 100000) / 100000).toFixed(5),
                    typeof data.finalScore === 'number' ? data.finalScore.toFixed(2) : parseFloat(data.finalScore).toFixed(2),
                    data.remarks
                ].join('\t');
                textContent += row + '\n';
            });
            
            navigator.clipboard.writeText(textContent).then(() => {
                alert('ë°ì´í„°ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\nExcelì— ë¶™ì—¬ë„£ê¸°(Ctrl+V)í•˜ì„¸ìš”.');
            }).catch(() => {
                const textArea = document.createElement('textarea');
                textArea.value = textContent;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('ë°ì´í„°ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\nExcelì— ë¶™ì—¬ë„£ê¸°(Ctrl+V)í•˜ì„¸ìš”.');
            });
        }

        function resetForm() {
            currentExamType = '';
            currentMethod = '';
            currentAbsenceReason = '';
            
            // ëª¨ë“  ë²„íŠ¼ ì´ˆê¸°í™”
            document.getElementById('midterm-btn').classList.remove('selected');
            document.getElementById('final-btn').classList.remove('selected');
            document.getElementById('performance-btn').classList.remove('selected');
            document.getElementById('english-listening-btn').classList.remove('selected');
            document.getElementById('sick-btn').classList.remove('selected');
            document.getElementById('approved-btn').classList.remove('selected');
            document.getElementById('unapproved-btn').classList.remove('selected');
            
            document.querySelectorAll('.method-option').forEach(btn => {
                btn.classList.remove('selected', 'border-blue-500', 'bg-blue-50');
                btn.classList.add('border-gray-200');
            });
            
            document.getElementById('absence-reason').classList.add('hidden');
            document.getElementById('calculation-method').classList.add('hidden');
            document.getElementById('input-form').classList.add('hidden');
            document.getElementById('input-fields').innerHTML = '';
            
            // ë“œë¡­ë‹¤ìš´ ì¹´ìš´í„° ì´ˆê¸°í™”
            dropdownPerformanceCounter = 0;
            dropdownPerformanceListeningCounter = 0;
        }

        function openFormulaModal() {
            const modal = document.getElementById('formula-modal');
            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        function closeFormulaModal() {
            const modal = document.getElementById('formula-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        function loadSavedAverages() {
            const grade = document.getElementById('student-grade').value;
            const subject = document.getElementById('student-subject').value;
            
            if (!grade || !subject) return;
            
            const key = `${grade}-${subject}`;
            const data = savedAverages[key];
            
            // ëª¨ë“  í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('midterm-avg-input').value = '';
            document.getElementById('midterm-min-input').value = '';
            document.getElementById('final-avg-input').value = '';
            document.getElementById('final-min-input').value = '';
            
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`perf${i}-name-input`).value = '';
                document.getElementById(`perf${i}-avg-input`).value = '';
                document.getElementById(`perf${i}-min-input`).value = '';
            }
            
            document.getElementById('listening-avg-input').value = '';
            document.getElementById('listening-min-input').value = '';
            
            if (data) {
                // ì§€í•„ê³ ì‚¬ í‰ê·  ë¡œë“œ
                if (data.midtermAvg) document.getElementById('midterm-avg-input').value = data.midtermAvg;
                if (data.midtermMin) document.getElementById('midterm-min-input').value = data.midtermMin;
                if (data.finalAvg) document.getElementById('final-avg-input').value = data.finalAvg;
                if (data.finalMin) document.getElementById('final-min-input').value = data.finalMin;
                
                // ìˆ˜í–‰í‰ê°€ í‰ê·  ë¡œë“œ
                for (let i = 1; i <= 4; i++) {
                    if (data[`perf${i}Name`]) document.getElementById(`perf${i}-name-input`).value = data[`perf${i}Name`];
                    if (data[`perf${i}Avg`]) document.getElementById(`perf${i}-avg-input`).value = data[`perf${i}Avg`];
                    if (data[`perf${i}Min`]) document.getElementById(`perf${i}-min-input`).value = data[`perf${i}Min`];
                }
                
                // ì˜ì–´ë“£ê¸° í‰ê·  ë¡œë“œ
                if (data.listeningAvg) document.getElementById('listening-avg-input').value = data.listeningAvg;
                if (data.listeningMin) document.getElementById('listening-min-input').value = data.listeningMin;
            }
        }

        function autoSaveAverages() {
            const grade = document.getElementById('student-grade').value;
            const subject = document.getElementById('student-subject').value;
            
            // í•™ë…„ê³¼ ê³¼ëª©ì´ ì„ íƒë˜ì–´ ìˆì„ ë•Œë§Œ ì €ì¥
            if (grade && subject) {
                const key = `${grade}-${subject}`;
                const data = {};
                
                // ì§€í•„ê³ ì‚¬ í‰ê·  ì €ì¥
                const midtermAvg = document.getElementById('midterm-avg-input').value;
                const midtermMin = document.getElementById('midterm-min-input').value;
                const finalAvg = document.getElementById('final-avg-input').value;
                const finalMin = document.getElementById('final-min-input').value;
                
                if (midtermAvg) data.midtermAvg = midtermAvg;
                if (midtermMin) data.midtermMin = midtermMin;
                if (finalAvg) data.finalAvg = finalAvg;
                if (finalMin) data.finalMin = finalMin;
                
                // ìˆ˜í–‰í‰ê°€ í‰ê·  ì €ì¥
                for (let i = 1; i <= 4; i++) {
                    const name = document.getElementById(`perf${i}-name-input`).value;
                    const avg = document.getElementById(`perf${i}-avg-input`).value;
                    const min = document.getElementById(`perf${i}-min-input`).value;
                    
                    if (name) data[`perf${i}Name`] = name;
                    if (avg) data[`perf${i}Avg`] = avg;
                    if (min) data[`perf${i}Min`] = min;
                }
                
                // ì˜ì–´ë“£ê¸° í‰ê·  ì €ì¥
                const listeningAvg = document.getElementById('listening-avg-input').value;
                const listeningMin = document.getElementById('listening-min-input').value;
                
                if (listeningAvg) data.listeningAvg = listeningAvg;
                if (listeningMin) data.listeningMin = listeningMin;
                
                savedAverages[key] = data;
                localStorage.setItem('savedAverages', JSON.stringify(savedAverages));
            }
            
            // ì˜ì–´ë“£ê¸° ì œì™¸ ìˆ˜í–‰í‰ê°€ í‰ê·  ìë™ ì—…ë°ì´íŠ¸
            updatePerformanceExcludingListeningAverage();
        }
        
        function updatePerformanceExcludingListeningAverage() {
            const perfExcludingField = document.getElementById('perf-excluding-listening-avg');
            if (perfExcludingField) {
                let totalAvg = 0;
                let count = 0;
                
                for (let i = 1; i <= 4; i++) {
                    const avgInput = document.getElementById(`perf${i}-avg-input`);
                    if (avgInput && avgInput.value) {
                        const avg = parseFloat(avgInput.value);
                        if (!isNaN(avg)) {
                            totalAvg += avg;
                            count++;
                        }
                    }
                }
                
                if (count > 0) {
                    perfExcludingField.value = (totalAvg / count).toFixed(2);
                } else {
                    perfExcludingField.value = '';
                }
            }
        }

        // ìˆ˜í–‰í‰ê°€ ë“œë¡­ë‹¤ìš´ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function populatePerformanceDropdown(dropdownId) {
            const grade = document.getElementById('student-grade').value;
            const subject = document.getElementById('student-subject').value;
            
            if (!grade || !subject) {
                console.log('í•™ë…„ ë˜ëŠ” ê³¼ëª©ì´ ì„ íƒë˜ì§€ ì•ŠìŒ');
                return;
            }
            
            const key = `${grade}-${subject}`;
            const data = savedAverages[key];
            const dropdown = document.getElementById(dropdownId);
            
            if (!dropdown) {
                console.log('ë“œë¡­ë‹¤ìš´ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:', dropdownId);
                return;
            }
            
            console.log('ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°:', dropdownId, 'ë°ì´í„°:', data);
            
            // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì²« ë²ˆì§¸ ì˜µì…˜ ì œì™¸)
            while (dropdown.children.length > 1) {
                dropdown.removeChild(dropdown.lastChild);
            }
            
            // í‰ê·  ì ìˆ˜ ê´€ë¦¬ì—ì„œ ì…ë ¥ëœ ë°ì´í„° ì§ì ‘ ê°€ì ¸ì˜¤ê¸°
            const performanceAreas = [];
            
            for (let i = 1; i <= 4; i++) {
                const nameInput = document.getElementById(`perf${i}-name-input`);
                const avgInput = document.getElementById(`perf${i}-avg-input`);
                const minInput = document.getElementById(`perf${i}-min-input`);
                
                if (nameInput && avgInput && nameInput.value && avgInput.value) {
                    performanceAreas.push({
                        index: i,
                        name: nameInput.value,
                        avg: avgInput.value,
                        min: minInput ? minInput.value : ''
                    });
                }
            }
            
            // ì˜ì–´ ê³¼ëª©ì¸ ê²½ìš° ì˜ì–´ë“£ê¸°ë„ ì¶”ê°€
            if (subject === 'ì˜ì–´') {
                const listeningAvgInput = document.getElementById('listening-avg-input');
                const listeningMinInput = document.getElementById('listening-min-input');
                
                if (listeningAvgInput && listeningAvgInput.value) {
                    performanceAreas.push({
                        index: 'listening',
                        name: 'ì˜ì–´ë“£ê¸°',
                        avg: listeningAvgInput.value,
                        min: listeningMinInput ? listeningMinInput.value : ''
                    });
                }
            }
            
            console.log('ì°¾ì€ ìˆ˜í–‰í‰ê°€ ì˜ì—­ë“¤:', performanceAreas);
            
            // ë“œë¡­ë‹¤ìš´ì— ì˜µì…˜ ì¶”ê°€
            performanceAreas.forEach(area => {
                const option = document.createElement('option');
                option.value = `${area.index}|${area.name}|${area.avg}|${area.min}`;
                option.textContent = area.name;
                dropdown.appendChild(option);
            });
            
            console.log('ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ì¶”ê°€ ì™„ë£Œ, ì´ ì˜µì…˜ ìˆ˜:', dropdown.children.length);
        }

        function populateAreaDropdown(areaNum) {
            const grade = document.getElementById('student-grade').value;
            const subject = document.getElementById('student-subject').value;
            
            if (!grade || !subject) return;
            
            const dropdown = document.getElementById(`area-select-${areaNum}`);
            
            if (!dropdown) return;
            
            // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì²« ë²ˆì§¸ ì˜µì…˜ ì œì™¸)
            while (dropdown.children.length > 1) {
                dropdown.removeChild(dropdown.lastChild);
            }
            
            // í‰ê·  ì ìˆ˜ ê´€ë¦¬ì—ì„œ ì…ë ¥ëœ ë°ì´í„° ì§ì ‘ ê°€ì ¸ì˜¤ê¸°
            const performanceAreas = [];
            
            for (let i = 1; i <= 4; i++) {
                const nameInput = document.getElementById(`perf${i}-name-input`);
                const avgInput = document.getElementById(`perf${i}-avg-input`);
                
                if (nameInput && avgInput && nameInput.value && avgInput.value) {
                    performanceAreas.push({
                        index: i,
                        name: nameInput.value,
                        avg: avgInput.value
                    });
                }
            }
            
            // ì˜ì–´ ê³¼ëª©ì¸ ê²½ìš° ì˜ì–´ë“£ê¸°ë„ ì¶”ê°€
            if (subject === 'ì˜ì–´') {
                const listeningAvgInput = document.getElementById('listening-avg-input');
                
                if (listeningAvgInput && listeningAvgInput.value) {
                    performanceAreas.push({
                        index: 'listening',
                        name: 'ì˜ì–´ë“£ê¸°',
                        avg: listeningAvgInput.value
                    });
                }
            }
            
            // ë“œë¡­ë‹¤ìš´ì— ì˜µì…˜ ì¶”ê°€
            performanceAreas.forEach(area => {
                const option = document.createElement('option');
                option.value = `${area.index}|${area.name}|${area.avg}`;
                option.textContent = area.name;
                dropdown.appendChild(option);
            });
        }

        function updateAreaAverage(areaNum) {
            const dropdown = document.getElementById(`area-select-${areaNum}`);
            const avgInput = document.getElementById(`class-performance-area${areaNum}`);
            
            if (dropdown && dropdown.value) {
                const [index, name, avg] = dropdown.value.split('|');
                if (avgInput) {
                    avgInput.value = avg;
                }
            } else {
                if (avgInput) {
                    avgInput.value = '';
                }
            }
        }

        function updatePerformanceAverage() {
            const dropdown = document.getElementById('absent-performance-area');
            const avgInput = document.getElementById('absent-performance-avg');
            const minInput = document.getElementById('performance-min');
            
            console.log('updatePerformanceAverage í˜¸ì¶œë¨, ì„ íƒëœ ê°’:', dropdown ? dropdown.value : 'dropdown ì—†ìŒ');
            
            if (dropdown && dropdown.value) {
                const parts = dropdown.value.split('|');
                const [index, name, avg, min] = parts;
                
                console.log('íŒŒì‹±ëœ ê°’ë“¤:', { index, name, avg, min });
                
                if (avgInput) {
                    avgInput.value = avg || '';
                }
                
                if (minInput) {
                    minInput.value = min || '';
                }
            } else {
                if (avgInput) {
                    avgInput.value = '';
                }
                if (minInput) {
                    minInput.value = '';
                }
            }
        }

        function autoFillField(fieldId, sourceId) {
            const sourceElement = document.getElementById(sourceId);
            const targetElement = document.getElementById(fieldId);
            
            if (sourceElement && targetElement) {
                targetElement.value = sourceElement.value;
            }
            
            // ì˜ì–´ë“£ê¸° ì œì™¸ ìˆ˜í–‰í‰ê°€ í‰ê·  ìë™ ê³„ì‚°
            if (fieldId === 'perf-excluding-listening-avg') {
                updatePerformanceExcludingListeningInForm();
            }
        }
        
        function updatePerformanceExcludingListeningInForm() {
            const targetElement = document.getElementById('perf-excluding-listening-avg');
            if (!targetElement) return;
            
            let totalAvg = 0;
            let count = 0;
            
            for (let i = 1; i <= 4; i++) {
                const avgInput = document.getElementById(`perf${i}-avg-input`);
                if (avgInput && avgInput.value) {
                    const avg = parseFloat(avgInput.value);
                    if (!isNaN(avg)) {
                        totalAvg += avg;
                        count++;
                    }
                }
            }
            
            if (count > 0) {
                targetElement.value = (totalAvg / count).toFixed(2);
            } else {
                targetElement.value = '';
            }
        }

        function getMinScore(examType, method) {
            const grade = document.getElementById('student-grade').value;
            const subject = document.getElementById('student-subject').value;
            
            if (!grade || !subject) return null;
            
            const key = `${grade}-${subject}`;
            const data = savedAverages[key];
            
            if (!data) return null;
            
            if (examType === 'midterm') {
                return parseFloat(data.midtermMin) || null;
            } else if (examType === 'final') {
                return parseFloat(data.finalMin) || null;
            } else if (examType === 'english-listening') {
                return parseFloat(data.listeningMin) || null;
            }
            
            return null;
        }

        function calculateClassPerformanceAverage() {
            const grade = document.getElementById('student-grade').value;
            const subject = document.getElementById('student-subject').value;
            
            if (!grade || !subject) return 0;
            
            const key = `${grade}-${subject}`;
            const data = savedAverages[key];
            
            if (!data) return 0;
            
            let totalAvg = 0;
            let count = 0;
            
            for (let i = 1; i <= 4; i++) {
                const avg = parseFloat(data[`perf${i}Avg`]);
                if (!isNaN(avg)) {
                    totalAvg += avg;
                    count++;
                }
            }
            
            // ì˜ì–´ ê³¼ëª©ì¸ ê²½ìš° ì˜ì–´ë“£ê¸°ë„ í¬í•¨
            if (subject === 'ì˜ì–´' && data.listeningAvg) {
                const listeningAvg = parseFloat(data.listeningAvg);
                if (!isNaN(listeningAvg)) {
                    totalAvg += listeningAvg;
                    count++;
                }
            }
            
            return count > 0 ? totalAvg / count : 0;
        }
    </script>
</body>
</html>
